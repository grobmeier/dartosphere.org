---
title: 'Headless Browser Testing: Dart, DumpRenderTree, drone.io'
layout: post
tags:
    - dart
    - dartlang
    - DumpRenderTree
    - testing
category: kevinwork
published: '2013-01-31T19:29:00-08:00'

---

<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-el8hBxU7v0I/UQrybo2AZDI/AAAAAAAAIH8/-I1adHW5o_E/s1600/bot_logo_headless.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-el8hBxU7v0I/UQrybo2AZDI/AAAAAAAAIH8/-I1adHW5o_E/s1600/bot_logo_headless.png" /></a></div>When writing any software, even for the web, I try to do as much testing as possible outside the browser.<br /><br />A lot of great testing can be done of algorithms, data models, and business logic without booting up Chrome.<br /><br />Node.js enabled this with Javascript. Dart has had an out-of-browser--read console--story since day one.<br /><br />But some things you must test in a browser.<br /><br />The <a href="https://github.com/kevmoo/bot.dart">Dart Bag of Tricks (BOT)</a>&nbsp;has had browser tests since the beginning. There are only a few tests that must be run in the browser, but I make sure to run all tests both on the console and in the browser if they can run both places.<br /><br />Browser tests are great, but they don't fit well into a build workflow or a continuous integration tool.<br /><br />For that you need a way to run and control a browser (or a browser-like thing) via the console and get results out. Enter DumpRenderTree.<br /><h2>DumpRenderTree - Chrome without the chrome</h2><div><a href="http://trac.webkit.org/wiki/Writing%20Layout%20Tests%20for%20DumpRenderTree" target="">DumpRenderTree</a>&nbsp;(DRT)&nbsp;is a great little tool hidden in the guts of <a href="http://www.webkit.org/">WebKit</a>.<br /><br />By default, DRT prints out an obscure text format representing the hierarchy of elements on the provided page.<br /></div><br />Here's the output for <code>DumpRenderTree example/fract/fract_demo.html</code><br /><br /><pre>Content-Type: text/plain<br />layer at (0,0) size 808x820<br />&nbsp; RenderView at (0,0) size 800x600<br />layer at (0,0) size 800x820<br />&nbsp; RenderBlock {HTML} at (0,0) size 800x820<br />&nbsp; &nbsp; RenderBody {BODY} at (8,8) size 784x804<br />&nbsp; &nbsp; &nbsp; RenderHTMLCanvas {CANVAS} at (0,0) size 800x800 [bgcolor=#808080]<br />&nbsp; &nbsp; &nbsp; RenderText {#text} at (0,0) size 0x0<br />#EOF<br />#EOF</pre><br />DRT is controlled mostly through Javascript in the test page by via <code>window.testRunner</code>.<br /><br />Here's the script block that lives in <code>test/harness_browser.html</code>:<br /><br /><pre>&lt;script&gt;<br />  <span style="color: blue;">// only run if testRunner is defined -- we're in DRT</span><br />  if (window.testRunner) {<br /><br />    <span style="color: blue;">// Don't dump the structure. Just the text of the output plus console output</span><br />    testRunner.dumpAsText();<br /><br />    <span style="color: blue;">// Don't finish when layout is done. Instead, wait to be notified</span><br />    testRunner.waitUntilDone();<br /><br />    <span style="color: blue;">// listen for messages from the test harness</span><br />    window.addEventListener("message", receiveMessage, false);<br /><br />    <span style="color: blue;">// listen for unhandled exceptions</span><br />    window.addEventListener('error', onError);<br />  }<br /><br />  <span style="color: blue;">// if there is an unhandled exception, tell DRT we're done</span><br />  function onError(event) {<br />    testRunner.notifyDone();<br />  }<br /><br />  <span style="color: blue;">// if the test harness sends a done message, tell DRT we're done</span><br />  function receiveMessage(event) {<br />    if(event.data == 'unittest-suite-done') {<br />      testRunner.notifyDone();<br />    }<br />  }<br />&lt;/script&gt;<br /></pre><br />And since everything is keyed off the existence of <code>window.testRunner</code>, none of this affects the behavior of tests running normally in a browser.<br /><br />Here's the first few lines of output from <code>DumpRenderTree test/harness_browser.html</code>:<br /><br /><pre>Content-Type: text/plain<br />PASS<br />All 109 tests passed<br />Collapse All<br />bot<br />&nbsp;<br />(4/4)<br />bot - Enumerable<br />&nbsp;<br />(19/19)<br />bot - Enumerable - group</pre><br />Compare to the content running the tests in the browser:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-7w_EmaAPcYw/UQsyPjvYFAI/AAAAAAAAIIM/NYL4js5hnEk/s1600/Screen+Shot+2013-01-31+at+10.09.37+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-7w_EmaAPcYw/UQsyPjvYFAI/AAAAAAAAIIM/NYL4js5hnEk/s1600/Screen+Shot+2013-01-31+at+10.09.37+PM.png" /></a></div><br /><h2>Getting DumpRenderTree</h2><div>DRT is part of Linux and Windows builds of the Dart Editor now (look in the chromium) directory. It will be part of builds for Mac <a href="https://code.google.com/p/dart/source/detail?r=17909">soon</a>.</div><div><br /></div><div>If you want to get DRT that is compatible with the latest integration build of Dart - 0.3.2.0 (r17657) - grab <a href="http://gsdview.appspot.com/dartium-archive/drt-mac-inc/drt-mac-inc-17651.0.zip">this guy</a>.</div><div><br /></div><div>Just make sure the DumpRenderTree executable is on your path when running tests.</div><h2>Bringing it all together</h2><div><a href="http://drone.io/">drone.io</a> supports DumpRenderTree for Dart projects. Read about it <a href="http://docs.drone.io/dart.html">here</a>.</div><div><br /></div><div>The trick is creating a script that returns an exit code of zero for success and not zero (1 is pretty standard) for failure.</div><div><br /></div><div>Check out the <a href="https://github.com/kevmoo/bot.dart/blob/1b9e186f6234cfcf835a8596533eb660e50dbb22/bin/run_browser_test_drt.sh">script I created</a> for BOT.</div><div><br /></div><div>And let me know how it goes for you.</div><div><br /></div><div>Happy hacking.</div><div><br /></div>
