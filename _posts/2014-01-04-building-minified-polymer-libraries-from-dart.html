---
title: 'Building Minified Polymer Libraries from Dart'
layout: post
tags:
    - chain
    - dart
    - dartlang
    - deployment
    - polymer
category: japhr-by-chris-strom
published: '2014-01-04T23:59:00-05:00'

---

<div class=top-chain-links></div><br />There are debug statements in my build code. Why are there debug statements in my build code?<br /><br />I was pleased with my progress at getting my “old” <a href="http://www.polymer-project.org/">Polymer</a> version of the <a href="https://github.com/eee-c/ice-code-editor">ICE Code Editor</a> back up and running—even to the point that I could build it for JavaScript-only browsers. Only... why is that debug code in the generated HTML?<pre class=prettyprint>&lt;html>&lt;head>&lt;script src="packages/shadow_dom/shadow_dom.<b>debug</b>.js">&lt;/script><br />&lt;script src="packages/custom_element/custom-elements.<b>debug</b>.js">&lt;/script><br />&lt;script src="packages/browser/interop.js">&lt;/script><br />  &lt;script src="polymer.html_bootstrap.dart.js">&lt;/script><br />&lt;/head><br />&lt;body>&lt;polymer-element name="ice-code-editor">&lt;!-- ... --><br />&lt;/body>&lt;/html></pre>It actually takes me a fair bit of digging, but I eventually find the following in <code>polymer/src/build/polyfill_injector.dart</code>:<pre class=prettyprint><code>      // TODO(sigmund): enable using .min.js. This currently fails in checked<br />      // mode because of bugs in dart2js mirrors (dartbug.com/14720).<br />      // var suffix = options.releaseMode ? '.min.js' : '.debug.js';<br />      var suffix = '.debug.js';</code></pre>I am not quite sure that I follow <a href="http://dartbug.com/14720">the bug</a>, but it seems like only affects unit testing. That is, I think that code would still work if the “min.js” versions were used, but there is currently no way for <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> to verify that it works. To put that theory to the test, I manually change both of the debug <code>&lt;script></code> tags to use the min versions instead:<pre class=prettyprint>&lt;html>&lt;head>&lt;script src="packages/shadow_dom/shadow_dom.<b>min</b>.js">&lt;/script><br />&lt;script src="packages/custom_element/custom-elements.<b>min</b>.js">&lt;/script><br />&lt;script src="packages/browser/interop.js">&lt;/script><br />  &lt;script src="polymer.html_bootstrap.dart.js">&lt;/script><br />&lt;/head><br />&lt;body>&lt;polymer-element name="ice-code-editor"><br />&lt;!-- ... --><br />&lt;/body>&lt;/html></pre>And that seems to do the trick. When I load my smoke test page, the Polymers still work and the Network tab confirms that the minified versions of the two libraries are being used:<br /><br /><a href="http://2.bp.blogspot.com/-NJ2x9mMQGiU/UsjjuyNsDAI/AAAAAAAAUw8/UaSkyHgCPL4/s1600/01-worky_with_minified_code.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-NJ2x9mMQGiU/UsjjuyNsDAI/AAAAAAAAUw8/UaSkyHgCPL4/s640/01-worky_with_minified_code.png" /></a><br /><br />The Polymers even work in Internet Explorer so I think I am good:<br /><br /><a href="http://4.bp.blogspot.com/-h5gMbXQqB9Y/UsjjuzvBX4I/AAAAAAAAUw4/4Er343Uog3s/s1600/02-even_in_ie.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-h5gMbXQqB9Y/UsjjuzvBX4I/AAAAAAAAUw4/4Er343Uog3s/s640/02-even_in_ie.png" /></a><br /><br />Hand editing code is never a useful thing to do. I could write a script that always does this for me, but I would still have to remember to run that every time I build my application. Actually, I know how to do this. I already <a href="http://japhr.blogspot.com/2013/12/dart-transformers-for-polymer-cleanup.html">wrote one pub transformer</a>. I can do it again. I start by adding an application specific transformer to my <code>pubspec.yaml</code>:<pre class="prettyprint">name: ice_code_editor<br />version: 0.0.11<br /># ...<br />dependencies:<br />  crypto: any<br />  js: any<br />  ctrl_alt_foo: any<br />  json: any<br />  polymer: any<br />transformers:<br />- polymer:<br />    entry_points: web/polymer.html<br /><b>- ice_code_editor:<br />    entry_points: web/polymer.html</b></pre>The transformer is then more or less a copy and paste job from that other transformer. The overall structure is identical (which means that I probably ought to extract it out into a library). The only difference is the name of the transformer (<code>ProductionMode</code>) and the regular expression replacement performed by the transformer's <code>apply()</code> method:<pre class="prettyprint">class ProductionMode extends Transformer {<br />  // ...<br />  Future apply(Transform transform) {<br />    var input = transform.primaryInput;<br />    return transform.<br />      readInputAsString(input.id).<br />      then((html){<br /><b>        var fixed = html.replaceAllMapped(<br />          new RegExp(r'\.debug\.js'),<br />          (m) => '.min.js'<br />        );</b><br />        transform.addOutput(new Asset.fromString(input.id, fixed));<br />      });<br />  }<br />}</pre>And that does the trick. It does not speed up the build transformation by any stretch of the imagination, but whenever I do build my Polymer for deployment, it now includes the minified version of the JavaScript libraries instead of the debugging versions.<br /><br />With that, I have a repeatable means of generating a minified version of my Polymer. At least until that bug is fixed.<br /><br /><span style="color: #ccc">Day #986</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/01/packing-old-polymers-for-new-browsers.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/01/cannot-minify-polymerdart.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script>
