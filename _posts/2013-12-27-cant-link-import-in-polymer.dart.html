---
title: 'Can''t link import in Polymer.dart'
layout: post
tags:
    - chain
    - dart
    - dartlang
    - i18n
    - polymer
category: japhr-by-chris-strom
published: '2013-12-27T23:59:00-05:00'

---

<div class=top-chain-links></div><br />I have what I think is a fairly nice localization implementation for <a href="http://www.polymer-project.org/">Polymer</a>. Only it doesn't work in <a href="http://dartlang.org">Dart</a>. At least I don't think that it does.<br /><br />A localized Polymer in my scheme looks something like:<pre class="prettyprint"><code>    &lt;link rel="import" href="packages/i18n_example/hello-you.html"><br />    &lt;link rel="import" href="packages/i18n_example/hello-you-en.json"><br />    &lt;link rel="import" href="packages/i18n_example/hello-you-fr.json"><br />    &lt;link rel="import" href="packages/i18n_example/hello-you-es.json"></code></pre>How a localized Polymer is coded by a web developer is almost inconsequential to me at this point. The JSON files can be supplied by the developer as above or can be bundled in the Polymer's <code>&lt;template></code>. What interests me more right now is getting the non-Polmer <code>&lt;link></code> imports working under Dart. And I think that means getting to know <a href="http://pub.dartlang.org/">Dart Pub</a> transformers better.<br /><br />Transformers are used to build Dart applications for deployment. They also run locally with the <code>pub serve</code> local development web server. This local feature is nice in that it runs an application just like it would for deployment, but allows for rapid code updates. Unfortunately, I think the Polymer transformer is stripping out my <code>&lt;link></code> imports. To verify, I start by commenting out the transformer from my <code>pubspec.yaml</code>:<pre class="prettyprint">name: i18n_example<br />dependencies:<br />  polymer: any<br />dev_dependencies:<br />  unittest: any<br /><b># transformers:<br /># - polymer:<br />#     entry_points: web/index.html</b></pre>And, yup, that fixes my problem. Instead of the large gap between the components and the transformed Polymer application that I had been seeing:<pre class="prettyprint"><code>    &lt;!-- Load component(s) --><br />    <br />    <br />    <br />    <br />    &lt;!-- Load Polymer --><br />    &lt;script type="application/dart" src="index.html_bootstrap.dart">&lt;/script></code></pre>I now see my Polymer along with the JSON configuration files that I wanted to see:<pre class=prettyprint><code>    &lt;!-- Load component(s) --><br />    &lt;link rel="import" href="packages/i18n_example/hello-you.html"><br />    &lt;link rel="import" href="packages/i18n_example/hello-you-en.json"><br />    &lt;link rel="import" href="packages/i18n_example/hello-you-fr.json"><br />    &lt;link rel="import" href="packages/i18n_example/hello-you-es.json"><br />    &lt;!-- Load Polymer --><br />    &lt;script type="application/dart"><br />      export 'package:polymer/init.dart';<br />    &lt;/script></code></pre>Now that I have access to my JSON localizations, I re-implement last night's JavaScript load-from-import in Dart:<pre class=prettyprint>@CustomTag('hello-you')<br />class HelloYou extends PolymerElement {<br />  // ...<br />  @published String locale = 'en';<br />  Map locales = {};<br /><br />  HelloYou.created(): super.created();<br /><br />  ready() {<br />    super.ready();<br /><br /><b>    var re = new RegExp(r'hello-you-(\w+).json');<br />    var list = ownerDocument.<br />      querySelectorAll('link[rel=import]').<br />      where((el)=> el.href.contains(re));<br /><br />    list.forEach((link) {<br />      var json = link.import.documentElement.text;<br />      var results = re.firstMatch(link.href);<br />      locales[results[1]] = JSON.decode(json);<br />    });<br /><br />    locales[locale].forEach((k, v)=> this[k] = v);</b><br />  }<br />  // ...<br />}</pre>See last night's post for the gruesome details. The brief summary is: get a list of JSON <code>&lt;link></code> elements, parse their contents as JSON, populate the corresponding locale, then set various values based on the currently selected locale. To make the the <code>this[k]</code> assignment work in Dart, I need to define an operator method, but that is pretty simple. That aside, the implementation is nearly identical to last night's JavaScript implementation. And it works the same. Well, almost:<br /><br /><a href="http://1.bp.blogspot.com/-ewahQ1uCy5s/Ur5NxpGXifI/AAAAAAAAUsE/OF8UTxFbsAI/s1600/01-whoops_not_utf8.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-ewahQ1uCy5s/Ur5NxpGXifI/AAAAAAAAUsE/OF8UTxFbsAI/s640/01-whoops_not_utf8.png" /></a><br /><br />Interestingly, the utf-8 encoded characters are being interpreted as some kind of single-byte character set (probably iso-8859-1). Bleh. Well, that's a bit odd, but I have no idea what the proper way to access <code>&lt;link></code> imported JSON is. My <code>link.import.documentElement.text</code> may be a bit off the beaten path. But that does not mean that there is no way to get it back onto the utf-8 path:<pre class="prettyprint"><code>    // ...<br />    list.forEach((link) {<br />      var results = re.firstMatch(link.href);<br /><b>      var json = UTF8.decode(link.import.documentElement.text.codeUnits);</b><br />      locales[results[1]] = JSON.decode(json);<br />    });<br />    // ...</code></pre>With that, I am in business:<br /><br /><a href="http://4.bp.blogspot.com/-LuVo9kz9Y3k/Ur5PbCAthCI/AAAAAAAAUsQ/vimMNT5yzrE/s1600/02-now_it_is_utf_8.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-LuVo9kz9Y3k/Ur5PbCAthCI/AAAAAAAAUsQ/vimMNT5yzrE/s640/02-now_it_is_utf_8.png" /></a><br /><br />Not surprisingly, if I reinstate the Polymer transformer, this no longer works. With the JSON <code>&lt;link></code> imports stripped from the document, my code no longer works. Bother. It seems I need to dig into the Polymer transformer to figure this out. That seems a topic for another day, so instead, I try an alternate approach to <code>&lt;link></code> importing. <br /><br />Instead of adding the <code>&lt;link></code> tags to the document, I add them to the Polymer's template:<pre class="prettyprint">&lt;polymer-element name="hello-you"><br />  &lt;template><br />    &lt;div>&lt;!-- ... -->&lt;/div><br /><b>    &lt;link rel="import" href="hello-you-en.json"><br />    &lt;link rel="import" href="hello-you-fr.json"><br />    &lt;link rel="import" href="hello-you-es.json"></b><br />  &lt;/template><br />  &lt;script type="application/dart" src="hello_you.dart">&lt;/script><br />&lt;/polymer-element></pre>Unfortunately, that does not work either. It seems polyfilling <code>&lt;link></code> imports is limited to the document itself because the <code>import</code> property of these links is always <code>null</code>.<br /><br />Ah, well. I suppose I can convert these to <code>&lt;polymer-ajax></code> tags or something along those lines. Tomorrow.<br /><br /><span style="color: #ccc">Day #978</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2013/12/a-possible-approach-to-polymer-i18n.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script>
