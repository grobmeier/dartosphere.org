---
title: 'Minification is not enough, you need tree shaking'
layout: post
tags:
    - dart
    - dartlang
    - webdev
category: seth-ladds-blog
published: '2013-01-29T10:41:00-08:00'

---

<div style="text-align: center;"><span style="font-size: x-large;"><i>In which the virtues of automated mechanical&nbsp;arboreal&nbsp;pruning are&nbsp;extolled&nbsp;over&nbsp;quaint&nbsp;manual labor, as applied to web development build processes.</i></span></div><br /><span style="font-size: large;">The setup</span><br /><br />Ever notice how the primary bit of marketing for many traditional web programming libraries is their download size? Why is that?<br /><div><br /></div><div>Check this out:<br /><div><br /></div><div class="separator" style="clear: both; text-align: center;"><img alt="jQuery claims it is only 32kb minified." border="0" height="332" src="http://1.bp.blogspot.com/-D9sfrEpCgYQ/UQd_2CsOc4I/AAAAAAAAPB0/kXHsw3Pco6I/s400/Screenshot_1_28_13_11_43_PM.png" title="" width="400" /></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><img alt="Zepto claims it is less than a quarter the size of jQuery." border="0" height="256" src="http://2.bp.blogspot.com/-92IPW75KTrU/UQd_6WaRtlI/AAAAAAAAPB8/9QN8x7OFtAg/s400/Screenshot_1_28_13_11_45_PM.png" title="" width="400" /></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><img alt="Dojo claims its nano core is 3.8kb." border="0" height="190" src="http://2.bp.blogspot.com/-X9x4MGPetOk/UQeAAjIP_9I/AAAAAAAAPCE/eiPbyQpVAxA/s400/Screenshot_1_28_13_11_51_PM.png" title="" width="400" /></div><div><br /></div><div>Why does size matter so much for these libraries? Your first instinct is probably, "because the more bytes you shuttle across the wire, the slower the app starts up." Yes, this is true. I'd also say you're wrong. The <i>primary</i> reason that size matters for these libraries is because <b>traditional web development has&nbsp;no intelligent or automated way to prune unused code</b>&nbsp;so you can ship&nbsp;only the code that is used&nbsp;over the wire.</div><div><br /></div><div><span style="font-size: large;">The web is full of links, yet web dev has no linker</span></div><div><br /></div><div><b>The web development workflow is missing a linking step.</b> A linker's job is to combine distinct project files into a single executable. A smart linker will only include the symbols and code that are actually used by the application, thus pruning unused code. The traditional web developer does not have an intelligent linker.</div><div><br /></div><div>It's 2013, and the job of micro-managing web development libraries is still being done by humans. Humans: the same people that brought you <a href="http://en.wikipedia.org/wiki/Great_Pacific_Garbage_Patch" target="_blank">this little gem</a>. <b>Web developers need machines and tools to take care of linking and minifying</b> so they can get back to comparing traditional web development libraries based on actual feature sets instead of how femto they are.</div></div><div><br /></div><div>I want my web programming language to offer enough structure and intelligent tools to take care of pruning, minification, and more. This is why I dig <a href="http://www.dartlang.org/" target="_blank">Dart</a>, because it has the structure (classes, libraries, packages, type annotations, metadata, etc) and the tools (dart2js) for a modern development workflow.</div><div><br /></div><div><span style="font-size: large;">Don't just prune unused code, shake it off</span></div><div><br /></div><div><b>Dart tools support tree shaking, a technique to "shake" off unused code</b>, thus shrinking the size of the deployed application. I can import rich libraries chock full of useful goodness into my application, but <b>only the functions I actually use will be included in my generated output</b>. Awesome!</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-QLudiPMjDrE/UQeWVmohsjI/AAAAAAAAPEY/oCP8zlJL8Ks/s1600/Dart+Tree+Shaking+(1).png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img alt="The source application goes through a tree-shaking compiler and its output is smaller." border="0" height="640" src="http://1.bp.blogspot.com/-QLudiPMjDrE/UQeWVmohsjI/AAAAAAAAPEY/oCP8zlJL8Ks/s640/Dart+Tree+Shaking+(1).png" title="" width="636" /></a></div><div><br /></div><div><span style="font-size: large;">Real code example, shaken not stirred</span></div><div><br /></div><div>Consider this simple Dart library, ironically named <i>embiggen.&nbsp;</i>There are two top-level functions in this library,&nbsp;<i>embiggen</i>&nbsp;and&nbsp;<i>unembiggen</i>.</div><div><br /></div><pre style="background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> library embiggen;  <br />   <br /> String embiggen(String msg) {  <br />  if (msg == null) {  <br />   throw new ArgumentError("must not be null");  <br />  }  <br />    <br />  return msg.toUpperCase();  <br /> }  <br />   <br /> String unembiggen(String msg) {  <br />  if (msg == null) {  <br />   throw new ArgumentError("must not be null");  <br />  }  <br />    <br />  return msg.toLowerCase();  <br /> }  </code></pre><div><br />Here is the main program, which uses <b>only</b> embiggen:<br /><br /></div><pre style="background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> import 'package:embiggen/embiggen.dart';  <br />   <br /> main() {  <br />  var args = new Options().arguments;  <br />  if (args.length == 0) {  <br />   print("Usage: dart embiggen.dart phrase");  <br />   return;  <br />  }  <br />    <br />  var phrase = args[0];  <br />    <br />  print(embiggen(phrase));  <br /> }  <br />   <br /></code></pre><div><br />I love embiggen, but I'm less entralled with unembiggen and will never use it. Do I have to search for nano-embiggen?! Nay! Let the linker do it's tree-shaking magic.<br /><br />Run the main application through the dart2js tool, which supports tree-shaking for both JavaScript and Dart outputs. Note there is no command-line option for tree shaking, because dart2js is always tree shaking. For simplicity's sake, let's generate Dart.<br /><br /></div><pre style="background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> dart2js --output-type=dart embiggen.dart  <br /></code></pre><div><br />Gaze into the tree-shook generated output (reformatted to make it easy to read):<br /><br /></div><pre style="background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;">main() {<br />  var args=new Options().arguments;<br />  if (args.length == 0) {<br />    print("Usage: dart embiggen.dart phrase");<br />    return;<br />  }<br />  var phrase=args[0];print(embiggen(phrase));<br />}<br /><br />String embiggen(String msg) {<br />  if (msg == null) {<br />    throw new ArgumentError("must not be null");<br />  }<br />  return msg.toUpperCase();<br />}<br /></code></pre><br /><i>(note: The actual output is actually all on one line, with white space removed. I reformatted the code above to make it easy to read.)</i><br /><br />Notice how the embiggen function is included, but <b>unembiggen is nowhere to be seen</b>, even though I imported the library. The tree, it is shaken!<br /><br />But is this the best we can do? The dart2js tool also supports minification with the --minify flag.<br /><br /><pre style="background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> dart2js <b>--minify</b> --output-type=dart embiggen.dart  <br /></code></pre><br />The minified, single-line, tree-shook generated output:<br /><br /><pre style="background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> main(){var A=new Options().arguments;if(A.length==0){print("Usage: dart<br />embiggen.dart phrase");return;}var C=A[0];print(B(C));}<br />B( A){if(A==null){throw new ArgumentError("must not be null");}<br />return A.toUpperCase();}  <br /></code></pre><br /><b>Both outputs have unused code eliminated, and the minified version also replaces variable names. This is exactly the kind of help I want from my tools.</b><br /><br /><span style="font-size: large;">Why this works</span><br /><br />The structure of Dart programs cannot change after compilation. In other words, Dart does not support altering class structure during runtime. Dart also does not have extreme&nbsp;dynamism&nbsp;like eval(). <b>Dart compilers and linkers can assume more about the structure of the program</b>, and thus can be more aggressive about tree shaking and minifications.<br /><br /><div><span style="font-size: large;">Moral of the story</span></div><div><br /></div><div>I believe that <b>web developers need a better workflow that automates tree shaking</b>, dead code elimination, minification, and more. Stop caring how big a library is, and instead let a tool or build step produce the smallest output possible for you, ideally by tree shaking the application.<br /><br />One option to consider is&nbsp;<a href="http://www.dartlang.org/" target="_blank">Dart</a>, with its&nbsp;structured language and intelligent tools, like a tree-shaking and minifying compiler. With dart2js, you can import entire libraries, regardless of size, and generate only the code that is required to run the program.<br /><br />Regardless of what language you use, demand more from your tools.</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><img border="0" height="260" src="http://1.bp.blogspot.com/-e9CclonRHqg/UQeQF2Fe2RI/AAAAAAAAPDs/RPFhinKX2oQ/s400/548040b489d0c5f41dd45ad7b3d5164c.png" width="400" />&nbsp;<img border="0" height="320" src="http://3.bp.blogspot.com/-PcvWhaJXr9g/UQeQCbQpwDI/AAAAAAAAPDk/s0DUIazFALI/s320/kelly_picking_medlar.png" width="240" /></div><div><br /><span style="font-size: large;">Acknowledgements</span><br /><br />Thanks to Bob Nystrom's OSCON presentation from 2012, from which I humbly embraced-and-extended the setup of this post.</div><img src="http://feeds.feedburner.com/~r/SethLaddsBlog/~4/okOCiSHeifE" height="1" width="1"/>
