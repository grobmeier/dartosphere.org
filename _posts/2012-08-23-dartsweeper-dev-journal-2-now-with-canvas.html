---
title: 'Dartsweeper: Dev Journal 2--now with Canvas'
layout: post
tags:
    - dartlang
    - Dartsweeper
    - internet
    - Programming
category: kevinwork
published: '2012-08-23T11:14:00-07:00'

---

<div class="separator" style="clear: both; text-align: center;"><a href="http://sweeper.j832.com/canvas/" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="640" src="http://4.bp.blogspot.com/-S83-1A7djM4/UDPshhm-KMI/AAAAAAAAHIE/gseNb5wzRT8/s640/Screen+Shot+2012-08-21+at+4.15.40+PM.png" width="433" /></a></div><h2>Looks can be&nbsp;deceiving</h2><div>Looks about the same as <a href="http://work.j832.com/2012/08/dartsweeper-dev-journal-1.html">last time</a>, right? The visuals and interaction were designed to be almost identical, but the plumbing is very different.<br /><br />The original, <a href="http://sweeper.j832.com/">HTML DOM version</a> used a table to render the game board. It's straight forward to let DOM elements handle layout and mouse interaction. Throw in a little CSS and you have a functional—albeit ugly—game.<br /><br />But if one wants to make something really amazing, without fighting a&nbsp;Matryoshka doll of layout and CSS issues, one should leave the DOM behind.<br /><br />Since I've decided leaving the third&nbsp;dimension for later, HTML canvas is an obvious choice. I also have a bit of of experience building games on canvas. See <a href="http://agent8ball.com/">Agent 8 Ball</a> and <a href="http://thinkpixellab.com/portfolio/throwingstars/">our work for Ze Frank</a>.<br /><h2>Darts on Canvas</h2>The <a href="http://sweeper.j832.com/canvas">working version of Dartsweeper</a> does all of its drawing and click handeling via canvas.&nbsp;Canvas is an&nbsp;<a href="http://en.wikipedia.org/wiki/Immediate_mode">immediate mode</a>&nbsp;graphics API. It's simple and straight-forward. It's also easy to have code complexity blow up once you start building anything complex.<br /><br />When I was building out the UI layer for Throwing Stars for Mr. Frank, I wanted an object-oriented way to think about game elements. I wanted a star object and a wall object and a coin object that encapsulated the game physics and element rendering. So I put on my <a href="http://www.joelonsoftware.com/articles/fog0000000018.html">astronaut suit</a>&nbsp;and built the <a href="http://thinkpixellab.github.com/pl/">PL javascript library</a>.&nbsp;PL is short for <a href="http://thinkpixellab.com/">Pixel Lab</a>.<br /><br />A big chunk of PL is under the <a href="https://github.com/thinkpixellab/pl/tree/master/src/retained">retained namespace</a>. It's a collection of types for <a href="http://en.wikipedia.org/wiki/Retained_mode">retained mode</a> graphics on canvas. I've <a href="https://github.com/kevmoo/dartlib/tree/master/lib/retained">ported most of the retained libraries</a> to my dartlib project and they are used heavily in Sweeper.</div><h2>Retained mode with Dartlib</h2><div>I'll probably do a video at some point about the retained model in dartlib. The short version:</div><div><ul><li><a href="https://github.com/kevmoo/dartlib/blob/master/lib/retained/stage.dart">Stage</a>: The glue between the DOM (a HTML Canvas element) and a root "element" in the retained world.</li><li><a href="https://github.com/kevmoo/dartlib/blob/master/lib/retained/pelement.dart">PElement</a>: The base class for visual elements in the retained world.</li><ul><li>Drawing is done with CanvasRenderContext2d. Super simple.</li><ul><li><a href="http://api.dartlang.org/docs/continuous/dart_html/CanvasRenderingContext2D.html">Dart API docs</a></li><li><a href="https://developer.mozilla.org/en-US/docs/DOM/CanvasRenderingContext2D">Mozilla docs</a></li></ul><li>Zero or more transforms, which allow layout by the parent and fun effects</li><li>Parent and child pointers</li><ul><li>Allow hit testing and mouse interaction</li></ul><li>The P prefix stands for Pixel Lab. I'm trying to avoid naming conflicts with <a href="http://api.dartlang.org/docs/continuous/dart_html/Element.html">Element</a>.</li></ul></ul>There's a bunch of other magic here, too. Mouse support. An attached property and attached event model. Support for correct Click behavior (mouse down the mouse up on the same element). Check out the samples in dartlib.</div><div><br /></div><div>If you're feeling really&nbsp;adventurous, take a look at <a href="https://github.com/kevmoo/vote.dart">vote.dart</a>. I have a lot of fun with retained graphics.</div><h2>Issues</h2><h3>Cross-browser confusion</h3><div>I've run into a couple of issues when trying to play the JS-compiled version of Dartsweeper on Firefox.&nbsp;</div><div><br /></div><div>In one case, I was using a webkit-specific version of requestAnimationFrame which doesn't exist on FireFox. Thankfully, Seth pointer me to the un-prefixed version of the API that works everywhere. <a href="http://code.google.com/p/dart/issues/detail?id=4585">A bug is open</a> to removed the webkit prefixes.</div><div><br /></div><div>In another case I discovered MouseEvent.offset[X|Y] don't exist in FireFox. There is <a href="http://code.google.com/p/dart/issues/detail?id=1087">a bug on this</a>, too. I added a <a href="https://github.com/kevmoo/dartlib/commit/b7c9b55f6b39307d1abdbff745e15c1998c8157d">helper to dartlib</a> provide the same functionality.</div><h3>Growing pains with pub</h3>I'm started tip-toeing into <a href="http://www.dartlang.org/docs/pub-package-manager/">pub</a> by migrating unit test code away from the copy in dartlib (which has been removed) to the SDK version.<br /><br />Setting up pub has caused me a bit of stress since I use a <a href="https://gist.github.com/2933621">custom homebrew formula</a> to keep my SDK updated. Pub needs the DART_SDK environment variable to be set and homebrew installs versions in directories based on the version number. This causes a bit of headache as I need to delete the packages directory and rerun <b>pub install</b> every time I update my copy of Dart.<br /><br />It's a bit of a headache, but it's purely related to how I install Dart. I'm hoping to tweak the homebrew formula to resolve this issue soon.<br /><h2>Next Steps</h2>All of the work to migrate the game to canvas would be a bit silly if the output still looks like a poorly styled table.<br /><br />After I finish up work storing high scores and created a touch-enabled interaction model, I'm going to jump into custom graphics, animation, and sound.<br /><br />I'm excited. Stay tuned.<br /><h2>Oh, and you can help</h2>All of the <a href="https://github.com/kevmoo/sweeper.dart">code is on github</a>. File issues. Fork and add features. I'd love collaborators.<br /><br />If you'd be interested in doing a hangout to discuss my graphics model, let me know.<br /><br />Cheers.
