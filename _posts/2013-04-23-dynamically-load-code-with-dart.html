---
title: 'Dynamically Load Code with Dart'
layout: post
tags:
    - dart
    - dartlang
category: seth-ladds-blog
published: '2013-04-23T21:17:00-07:00'

---

Rejoice! Dartium, a build of Chromium with the Dart VM, can now spawn a new isolate from a URI. This means your Dart apps have a new option for more modular code.<br /><br /><span style="font-size: large;">Isolates</span><br /><br />In Dart, an <i>isolate</i> is an abstraction for an "isolated memory heap". Isolates do not share memory (variables, statics, etc), they are essentially self-contained applications. Isolates communicate by sending and receiving messages over <i>ports</i>.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-lKoB2jUTX6U/UXdS8wuphdI/AAAAAAAAV1I/Jf78_URD_Fc/s1600/Dart+isolates+diagram+(1).png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-lKoB2jUTX6U/UXdS8wuphdI/AAAAAAAAV1I/Jf78_URD_Fc/s1600/Dart+isolates+diagram+(1).png" /></a></div><br /><span style="font-size: large;">Why Isolates Matter</span><br /><br />Dart programs are static, in that their shape and structure do not change after they are compiled. A static program is great for optimizations like tree shaking (aka dead code elimination), type-inferencing compilers, and more.<br /><br />However, modular apps often require a way to dynamically load code. Configurable and modular apps need a way to, at run time, pull in new functionality. If Dart apps have a static structure, how can they dynamically alter their behavior?<br /><br />Isolates to the rescue! The structure inside of an isolate is static, but a Dart program is free to dynamically load other isolates. This means that libraries can be loaded into isolates at run time.<br /><br /><span style="font-size: large;">Your First Isolate</span><br /><br />This simple&nbsp;<i>reverser</i>&nbsp;isolate listens on its port, receives messages, reverses them, and send the reversed text back to the sender.<br /><br /><span style="font-family: Courier New, Courier, monospace;">// reverser.dart</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><br /><div class="p1"><span style="font-family: Courier New, Courier, monospace;"><span class="s1">import</span><span class="s2"> </span>'dart:isolate'<span class="s2">;</span></span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;"><span class="s3">main</span>() {</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; <span class="s4">port</span>.receive((msg, SendPort replyTo) {</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; <span class="s1">var</span> reverse = msg <span class="s1">as</span> String;</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; <span class="s1">var</span> buffer = <span class="s1">new</span> StringBuffer();</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; <span class="s1">for</span> (<span class="s1">var</span> i = reverse.<span class="s4">length</span> - <span class="s5">1</span>; i &gt;= <span class="s5">0</span>; i--) {</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; buffer.write(reverse[i]);</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; }</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; replyTo.send(buffer.toString());</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">&nbsp; });</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">}</span></div><div class="p3"><br /></div><div class="p3">The main application (which itself is an isolate), is responsible for instantiating the reverser isolate. Use the <span style="font-family: Courier New, Courier, monospace;">spawnUri()</span> function from <span style="font-family: Courier New, Courier, monospace;">dart:isolate</span> to spawn a new isolate from some file.</div><div class="p3"></div><div class="p1"><br /></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;">// main.dart</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">SendPort <span class="s1">reverser</span>;</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;"><span class="s2">void</span> <span class="s3">main</span>() {</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;"><span class="s4">&nbsp; query(</span>"#sample_text_id"<span class="s4">)</span></span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;"><span class="s4">&nbsp; &nbsp; ..</span><span class="s1">text</span><span class="s4"> = </span>"Click me!"</span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; ..<span class="s1">onClick</span>.listen(reverseText);</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;</span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;">&nbsp; <span class="s2">var</span> serviceFile = <span class="s5">'reverser.dart'</span>;</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;</span></div><div class="p4"><span style="font-family: Courier New, Courier, monospace;"><span class="s4">&nbsp; </span><span class="s2">if</span><span class="s4"> (identical(</span><span class="s6">1</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">)) {&nbsp; </span>// <span class="s7">XXX</span>: horrible hack to detect if we're in JS</span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; serviceFile = <span class="s5">'reverser.dart.js'</span>;</span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;">&nbsp; }</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;</span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;">&nbsp; <span class="s1">reverser</span> = spawnUri(serviceFile);</span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;">}</span></div><div class="p2"><br /></div><div class="p2">Notice the horrible hack to detect if this code is running in the Dart VM or JavaScript. I don't know a better way to do it, but I don't recommend this.</div><div class="p2"><br /></div><div class="p2">When the text from #sample_text_id is clicked, the reverseText function is run:<br /><br /><br /><div class="p1"><span style="font-family: Courier New, Courier, monospace;"><span class="s1">void</span> <span class="s2">reverseText</span>(MouseEvent event) {</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp; <span class="s1">var</span> text = query(<span class="s3">"#sample_text_id"</span>).<span class="s4">text</span>;</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp; <span class="s4">reverser</span>.call(text).then((reversed) {</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; query(<span class="s3">"#sample_text_id"</span>).<span class="s4">text</span> = reversed;</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">&nbsp; });</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">}</span></div><div class="p1"><br /></div><div class="p1">Notice how the reverser isolate is sent a message via call(), which returns a Future. When the Future completes, the callback registered with then() is run.</div><div class="p1"><br /></div><div class="p1"><span style="font-size: large;">Support</span></div><div class="p1"><br /></div><div class="p1">Dartium supports spawnUri since at least version 28.0.1478.0 (194114). Dart2js compiles spawnUri() into a Web worker.</div><div class="p1"><br /></div><div class="p1">Note that each isolate is its own app, so dart2js must compile the same bootstrap code into each isolate file.</div></div><img src="http://feeds.feedburner.com/~r/SethLaddsBlog/~4/crw8ORXbGME" height="1" width="1"/>
