---
title: 'Day 992: Search and Replace Dart Transformer to Hide from Polymer'
layout: post
tags:
    - chain
    - dart
    - dartlang
    - deployment
    - polymer
    - transformer
category: japhr-by-chris-strom
published: '2014-01-10T23:59:00-05:00'

---

<div class=top-chain-links></div><br />OK I lied. Yesterday, I breezed past a little <a href="http://dartlang.org">Dart</a> problem in an effort to finish off some work. Today I try to address that oversight.<br /><br />As I briefly mentioned yesterday, I am able to read <a href="http://www.polymer-project.org/">Polymer</a> configuration that is stored <code>&lt;link></code> imports inside the definition of a Dart Polymer:<pre class=prettyprint>&lt;script src="../../packages/browser/dart.js">&lt;/script><br />&lt;script src="../../packages/browser/interop.js">&lt;/script><br />&lt;polymer-element name="hello-you"><br /><b>  &lt;link rel="import" href="hello-you.json"></b><br />  &lt;template><br />    &lt;!-- ... --><br />  &lt;/template><br />  &lt;script type="application/dart" src="hello_you.dart">&lt;/script><br />&lt;/polymer-element></pre>It takes a little effort, but I can grab <code>hello-you.json</code> from the Polymer, reading the data into the Polymer's configuration data. I have to work through the <a href="http://japhr.blogspot.com/2013/12/dart-transformers-for-polymer-cleanup.html">declaration property and run the result through a transformer</a>, but it is doable.<br /><br />What I cannot quite do is <code>&lt;link></code> import data when I use the Polymer:<pre class=prettyprint>&lt;hello-you><br /><b>  &lt;link rel="import" href="hello-you.json"></b><br />  &lt;p>And good-bye…&lt;/p><br />&lt;/hello-you></pre>My problem is something of a running theme with <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a>—the deployment transformer includes <code>&lt;link></code> imports inline, which results in actually seeing the JSON data embedded diring in the web page:<br /><br /><a href="http://4.bp.blogspot.com/-_ZR0z1IUqBM/UtCxKPUjZyI/AAAAAAAAUzQ/qKfq7Cuy8Y4/s1600/01-json_displayed.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-_ZR0z1IUqBM/UtCxKPUjZyI/AAAAAAAAUzQ/qKfq7Cuy8Y4/s640/01-json_displayed.png" /></a><br /><br />I can work around this inside the Polymer definition with a deployment build transformer that searched for raw JSON, wrapping it in a <code>display: none</code> styled tag. The actual <code>&lt;link></code> tag remains in the Polymer, allowing me to read it as configuration.<br /><br />My problem with configuration in a Polymer is twofold. First, it is a little harder to find the JSON to wrap it inside <code>display: none</code> tags. Second, even if I could do so, the <code>&lt;link></code> tag is stripped out so that I could not read it even if I wanted to do so. I end up with this in the main web page:<pre class=prettyprint>{<br />  "hello": "Yo"<br />}<br />&lt;div class="container"><br />  &lt;hello-you><br />    <br />    &lt;p>And good-bye…&lt;/p><br />  &lt;/hello-you><br />&lt;/div></pre>I think the best thing would be to pre-transform the page so that, by the time the Polymer transformer sees it, it is no longer a <code>&lt;link></code>. The pre-transformer could take the Polymer:<pre class=prettyprint>&lt;hello-you><br /><b>  &lt;link rel="import" href="hello-you.json"></b><br />  &lt;p>And good-bye…&lt;/p><br />&lt;/hello-you></pre>And transform it to:<pre class=prettyprint>&lt;hello-you><br /><b>  &lt;!-- link rel="import" href="hello-you.json" --></b><br />  &lt;p>And good-bye…&lt;/p><br />&lt;/hello-you></pre>Then the code could pass through the Polymer transformer, which can do its usual thing—except that it will skip the commented <code>&lt;link></code> tag. Finally, a post-transformer could restore the original <code>&lt;link></code>:<pre class=prettyprint>&lt;hello-you><br /><b>  &lt;link rel="import" href="hello-you.json"></b><br />  &lt;p>And good-bye…&lt;/p><br />&lt;/hello-you></pre>I have gotten pretty good at writing search and replace <a href="http://pub.dartlang.org/">Dart Pub</a> transformers. So good, in fact, that I think it is time to write a pub package. If I call the package <code>replace_transformer</code>, then my application could have a <code>pubspec.yaml</code> that looks like:<pre class="prettyprint">name: config_example<br />dependencies:<br />  polymer: any<br /><b>  replace_transformer:<br />    path: /home/chris/repos/replace_transformer</b><br />dev_dependencies:<br />  unittest: any<br />transformers:<br /><b>- replace_transformer:<br />    file: web/index.html<br />    match: '&lt;link rel="import" href="hello-you.json">'<br />    replace: '&lt;!-- link rel="import" href="hello-you.json" -->'<br />- polymer:<br />    entry_points: web/index.html<br />- replace_transformer:<br />    file: web/index.html<br />    match: '&lt;!-- link rel="import" href="hello-you.json" -->'<br />    replace: '&lt;link rel="import" href="hello-you.json">'</b></pre>In the <code>dependencies</code> section of <code>pubspec.yaml</code>, I mark my new <code>replace_transformer</code> package as a dependency. Once I am ready to release this package to <a href="http://pub.dartlang.org">pub.dartlang.org</a>, I will remove the local path. For now, the local path allows me to build my transformer and try it right away. Brilliant!<br /><br />There are two ways to name a Dart transformer and I have forgotten one of them. The one I do remember is to create a file named <code>transformer.dart</code>. So in <code>replace_transformer</code>, I create <code>lib/transformer</code>:<pre class=prettyprint>library replace.transformer;<br />import 'dart:async';<br />import 'package:barback/barback.dart';<br /><br />class ReplaceTransformer extends Transformer {<br />  String file;<br />  Pattern match;<br />  String replace;<br /><br />  ReplaceTransformer(this.file, this.match, this.replace);<br /><br />  Future<bool> isPrimary(Asset input) { /* ... */ }<br /><br />  Future apply(Transform transform) { /* ... */ }<br />}</pre>Nothing out of the ordinary there. I declare a library. I import packages—async for access to <code>Future</code> and <code>barback</code> from pub itself for the <code>Transformer</code> class as well as the ability to read the <code>pubspec.yaml</code> configuration. I declare the three instance variables that will be assigned from <code>pubspec.yaml</code> and define a constructor that assigns those instance variables. Lastly, I define the two methods that need to be implemented by a subclass of <code>Transformer</code>. The <code>isPrimary()</code> method indicates if a particular asset needs to be directly transformed (it will have to return <code>true</code> when the asset matches <code>file</code>). And the <code>apply()</code> method actually performs the transformation.<br /><br />Pub expects its tranformers to define an <code>asPlugin</code> named constructor which access barback settings:<pre class="prettyprint">class ReplaceTransformer extends Transformer {<br />  String file;<br />  Pattern match;<br />  String replace;<br /><br />  ReplaceTransformer(this.file, this.match, this.replace);<br /><br /><b>  ReplaceTransformer.fromList(List a): this(a[0], a[1], a[2]);<br /><br />  ReplaceTransformer.asPlugin(BarbackSettings settings)<br />    : this.fromList(_parseSettings(settings));</b><br />  // ...<br />}</pre>I redirect this constructor to the <code>fromList()</code> named constructor that takes a list and redirects to the primary constructor with the three expected values. The <code>_parsedSettings()</code> is easy enough:<pre class=prettyprint>List&lt;String> _parseSettings(BarbackSettings settings) {<br />  var args = settings.configuration;<br />  return [<br />    args['file'],<br />    args['match'],<br />    args['replace']<br />  ];<br />}</pre>With that, I need to teach my <code>ReplaceTransfomer</code> when to apply transforms:<pre class=prettyprint><code>  Future&lt;bool> isPrimary(Asset input) {<br />    if (file == input.id.path) return new Future.value(true);<br />    return new Future.value(false);<br />  }</code></pre>And I need to replace all instances of <code>match</code> with <code>replace</code> when the transform is applied:<pre class=prettyprint><code>  Future apply(Transform transform) {<br />    var input = transform.primaryInput;<br />    return transform.<br />      readInputAsString(input.id).<br />      then((html){<br /><b>        var fixed = html.replaceAllMapped(<br />          match,<br />          (m) => replace<br />        );</b><br /><br />        transform.addOutput(new Asset.fromString(input.id, fixed));<br />      });<br />  }</code></pre>And that actually does the trick. Now when I load my Polymer, the <code>&lt;link></code> tag makes it through Polymer's transformer unscathed:<br /><br /><a href="http://3.bp.blogspot.com/-bFaIWwcsXlg/UtDHQI-CfqI/AAAAAAAAUzg/1URxABugmuc/s1600/02-json_imported.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-bFaIWwcsXlg/UtDHQI-CfqI/AAAAAAAAUzg/1URxABugmuc/s640/02-json_imported.png" /></a><br /><br />Nice! I am still a little uncertain how to approach this stuff in <a href="http://patternsinpolymer.com">Patterns in Polymer</a>, especially since the JavaScript version of Polymer does not really have the concept of asset packaging. But, for now, I am glad to feel like I have a workable, if a bit verbose solution in Dart.<br /><br /><span style="color: #ccc">Day #992</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/01/day-991-mixing-config-and-content-in.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script>
