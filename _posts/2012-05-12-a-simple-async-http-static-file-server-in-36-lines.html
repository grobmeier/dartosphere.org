---
title: 'A Simple Async HTTP Static File Server in 36 Lines'
layout: post
tags: {  }
category: dartery
published: '2012-05-12T17:43:00-07:00'

---

Sorry for the long radio silence since I last blogged about Dart. I haven't been able to do as much extra-curricular programming as I'd like lately, and for a while Dart wasn't ready to handle many of the experiments I wanted to try.<br /><br />Luckily, or more accurately, due to the incredible work of the Dart team, the language and libraries have come a long way and I finally got back to trying out WebSocket support. I'm very glad to report that all of the issues I ran into last time have been solved. Great work Dart team!<br /><br />Along the way towards an end-to-end WebSocket demo, I needed to serve some static files - just the basic HTML, JavaScript and Dart assets - so I coded up a quick static file server using the new-ish dart:io HttpServer.<br /><br />My first cut used the File.*Sync() methods, because I'm no node.js junkie and that's what I'm used to. I quickly saw that the async APIs are pretty easy to use, and the code isn't <i>too</i> ugly, assuming you're not chaining together too many async calls. So here it is, a static file server in 36, quite readable, lines:<br /><br /><div class="syntax"><pre>#<span class="k">import</span><span class="p">(</span><span class="s1">'dart:io'</span><span class="p">);</span><br /><br /><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="o">&gt;</span> <span class="n">contentTypes</span> <span class="o">=</span> <span class="kd">const</span> <span class="p">{</span><br />  <span class="s2">"html"</span><span class="o">:</span> <span class="s2">"text/html; charset=UTF-8"</span><span class="p">,</span><br />  <span class="s2">"dart"</span><span class="o">:</span> <span class="s2">"application/dart"</span><span class="p">,</span><br />  <span class="s2">"js"</span><span class="o">:</span> <span class="s2">"application/javascript"</span><span class="p">,</span> <br /><span class="p">};</span><br /><br /><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span><br />  <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpServer</span><span class="p">();</span><br />  <span class="n">server</span><span class="p">.</span><span class="n">addRequestHandler</span><span class="p">((</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span> <span class="n">serveFile</span><span class="p">);</span>  <br />  <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="s2">"127.0.0.1"</span><span class="p">,</span> <span class="m">8080</span><span class="p">);</span>  <br /><span class="p">}</span><br /><br /><span class="c1">/// Very simple async static file server. Possibly insecure!</span><br /><span class="kt">void</span> <span class="n">serveFile</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">req</span><span class="p">,</span> <span class="n">HttpResponse</span> <span class="n">resp</span><span class="p">)</span> <span class="p">{</span><br />  <span class="kt">String</span> <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="s1">'/'</span><span class="p">))</span> <span class="o">?</span> <span class="s2">".</span><span class="si">${</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="s2">index.html"</span> <span class="o">:</span> <span class="s2">".</span><span class="si">${</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span><br />  <span class="n">print</span><span class="p">(</span><span class="s2">"serving </span><span class="si">$</span><span class="n">path</span><span class="s2">"</span><span class="p">);</span><br />  <br />  <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><br />  <span class="n">file</span><span class="p">.</span><span class="n">exists</span><span class="p">().</span><span class="n">then</span><span class="p">((</span><span class="kt">bool</span> <span class="n">exists</span><span class="p">)</span> <span class="p">{</span><br />    <span class="k">if</span> <span class="p">(</span><span class="n">exists</span><span class="p">)</span> <span class="p">{</span><br />      <span class="n">file</span><span class="p">.</span><span class="n">readAsText</span><span class="p">().</span><span class="n">then</span><span class="p">((</span><span class="kt">String</span> <span class="n">text</span><span class="p">)</span> <span class="p">{</span><br />        <span class="n">resp</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="n">HttpHeaders</span><span class="p">.</span><span class="n">CONTENT_TYPE</span><span class="p">,</span> <span class="n">getContentType</span><span class="p">(</span><span class="n">file</span><span class="p">));</span><br />        <span class="n">resp</span><span class="p">.</span><span class="n">outputStream</span><span class="p">.</span><span class="n">writeString</span><span class="p">(</span><span class="n">text</span><span class="p">);</span><br />        <span class="n">resp</span><span class="p">.</span><span class="n">outputStream</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><br />      <span class="p">});</span>      <br />    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><br />      <span class="n">resp</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">NOT_FOUND</span><span class="p">;</span><br />      <span class="n">resp</span><span class="p">.</span><span class="n">outputStream</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><br />    <span class="p">}</span><br />  <span class="p">});</span><br /><span class="p">}</span><br /><br /><span class="kt">String</span> <span class="n">getContentType</span><span class="p">(</span><span class="n">File</span> <span class="n">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">contentTypes</span><span class="p">[</span><span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">).</span><span class="n">last</span><span class="p">()];</span><br /></pre></div><br />Now, I wouldn't actually <i>use</i>&nbsp;this server. It's missing all kinds of error checking and probably exposes every file on your computer. It does show that the APIs are pretty nice and understandable though. I still find Dart much more readable that either Java or JavaScript.<br /><br />Next time I'll show a full client and server Dart application that uses this server to send the HTML and Dart or JavaScript to the browser and WebSockets for subsequent server pushes.<br /><br />Cheers!<br /><br /><i>edit: I switched to a Map literal for the content types. I keep forgetting about Dart's nice literal syntax.</i>
