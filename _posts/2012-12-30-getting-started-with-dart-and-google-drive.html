---
title: 'Getting started with Dart and Google Drive'
layout: post
tags: {  }
category: random-posts-about-coding
published: '2012-12-30T16:27:00-08:00'

---

<p>Following the example code from google drive <a href="https://developers.google.com/drive/quickstart-js">quickstart</a> I was able to recreate the sample in <a href="http://www.dartlang.org">Dart</a>. A lot of the heavy lifting is done by the <a href="https://github.com/dart-lang/js-interop">js-interop</a> cause of the dependency on <a href="http://code.google.com/p/google-api-javascript-client">google javascript client api</a>. This solution is fine for now, I&#8217;d take a good guess the dart team will provide client apis at some point.</p>

<p>Started off by creating a new sample project <code>dart_drive_quickstart</code>, removed all default code and add js-interop.</p>

<p><a href="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/create-new-app.png"><img src="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/create-new-app.png" alt="create-new-app" /></a></p>

<p><a href="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/remove-defaults.png"><img src="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/remove-defaults.png" alt="remove-defaults" /></a></p>

<p>Bring in the javascript client apis as <code>ScriptElement</code> and set a <code>onload</code> handler to a dart callback.</p>

<figure class='code'><figcaption><span>dart_drive_quickstart.dart</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="n">import</span> <span class="s1">&#39;dart:html&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">import</span> <span class="s1">&#39;dart:json&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">import</span> <span class="s1">&#39;package:js/js.dart&#39;</span> <span class="n">as</span> <span class="n">js</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">final</span> <span class="kt">String</span> <span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s1">&#39;&lt;YOURCLIENTID&gt;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">final</span> <span class="kt">String</span> <span class="n">SCOPE</span> <span class="o">=</span> <span class="s1">&#39;https://www.googleapis.com/auth/drive&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">js</span><span class="p">.</span><span class="n">scoped</span><span class="p">((){</span>
</span><span class='line'>    <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">handleAuthResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">((</span><span class="n">js</span><span class="p">.</span><span class="n">Proxy</span> <span class="n">authResult</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Map</span> <span class="n">dartAuthResult</span> <span class="o">=</span> <span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">authResult</span><span class="p">));</span>
</span><span class='line'>      <span class="n">print</span><span class="p">(</span><span class="s2">&quot;dartAuthResult = </span><span class="si">${</span><span class="n">dartAuthResult</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">handleClientLoad</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">(()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">setTimeout</span><span class="p">(</span><span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">checkAuth</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">checkAuth</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">(()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">gapi</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">authorize</span><span class="p">(</span>
</span><span class='line'>          <span class="n">js</span><span class="p">.</span><span class="n">map</span><span class="p">({</span>
</span><span class='line'>              <span class="s1">&#39;client_id&#39;</span><span class="o">:</span> <span class="n">CLIENT_ID</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;scope&#39;</span><span class="o">:</span> <span class="n">SCOPE</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;immediate&#39;</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>            <span class="p">}),</span>
</span><span class='line'>            <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">handleAuthResult</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>        
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ScriptElement</span> <span class="n">script</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScriptElement</span><span class="p">();</span>
</span><span class='line'>  <span class="n">script</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;http://apis.google.com/js/client.js?onload=handleClientLoad&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">script</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">document</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">script</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Manually adding the script code and hooking up a callback from javascript to dart seemed to work fine. I ran into issues with callbacks not being scoped when they should of been scoped. Another odd thing was the need for the call to <code>setTimeout</code>, the callback to <code>handleAuthResult</code> would not get fired if <code>checkAuth</code> was not called from <code>setTimeout</code>.</p>

<p>The rest of the code included was for the most part a direct translation of the quickstart sample. Added some dart flavoring when appropriate.</p>

<p>Here are some action shots and code. The full project can be found on github <a href="https://github.com/financeCoding/dart_drive_quickstart">dart_drive_quickstart</a></p>

<p><a href="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/app-launched.png"><img src="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/app-launched.png" alt="app-launched" /></a></p>

<p><a href="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/file-choose.png"><img src="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/file-choose.png" alt="file-choose" /></a></p>

<p><a href="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/file-uploaded.png"><img src="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/file-uploaded.png" alt="file-uploaded" /></a></p>

<p><a href="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/file-opened-in-drive.png"><img src="http://financeCoding.github.com/images/2012-12-30-getting-started-with-dart-and-google-drive/file-opened-in-drive.png" alt="file-opened-in-drive" /></a></p>

<figure class='code'><figcaption><span>dart_drive_quickstart.dart</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
</pre></td><td class='code'><pre><code class='dart'><span class='line'><span class="n">import</span> <span class="s1">&#39;dart:html&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">import</span> <span class="s1">&#39;dart:json&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">import</span> <span class="s1">&#39;package:js/js.dart&#39;</span> <span class="n">as</span> <span class="n">js</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">final</span> <span class="kt">String</span> <span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s1">&#39;299615367852.apps.googleusercontent.com&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">final</span> <span class="kt">String</span> <span class="n">SCOPE</span> <span class="o">=</span> <span class="s1">&#39;https://www.googleapis.com/auth/drive&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">js</span><span class="p">.</span><span class="n">scoped</span><span class="p">((){</span>
</span><span class='line'>    <span class="kt">void</span> <span class="n">insertFile</span><span class="p">(</span><span class="n">File</span> <span class="n">fileData</span><span class="p">,</span> <span class="p">[</span><span class="n">callback</span> <span class="o">=</span> <span class="kc">null</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">String</span> <span class="n">boundary</span> <span class="o">=</span> <span class="s1">&#39;-------314159265358979323846&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">String</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;\r\n--</span><span class="si">$</span><span class="n">boundary</span><span class="s2">\r\n&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">String</span> <span class="n">close_delim</span> <span class="o">=</span> <span class="s2">&quot;\r\n--</span><span class="si">$</span><span class="n">boundary</span><span class="s2">--&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileReader</span><span class="p">();</span>
</span><span class='line'>      <span class="n">reader</span><span class="p">.</span><span class="n">readAsBinaryString</span><span class="p">(</span><span class="n">fileData</span><span class="p">);</span>
</span><span class='line'>      <span class="n">reader</span><span class="p">.</span><span class="n">on</span><span class="p">.</span><span class="n">load</span><span class="p">.</span><span class="n">add</span><span class="p">((</span><span class="n">Event</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="n">contentType</span> <span class="o">=</span> <span class="n">fileData</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">contentType</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">contentType</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;title&#39;</span> <span class="o">:</span> <span class="n">fileData</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;mimeType&#39;</span> <span class="o">:</span> <span class="n">contentType</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="n">base64Data</span> <span class="o">=</span> <span class="n">window</span><span class="p">.</span><span class="n">btoa</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">String</span><span class="n">Buffer</span><span class="p">();</span>
</span><span class='line'>        <span class="n">sb</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Content-Type: application/json\r\n\r\n&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Content-Type: &#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="n">contentType</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;\r\n&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Content-Transfer-Encoding: base64\r\n&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;\r\n&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="n">base64Data</span><span class="p">)</span>
</span><span class='line'>        <span class="p">..</span><span class="n">add</span><span class="p">(</span><span class="n">close_delim</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="n">multipartRequestBody</span> <span class="o">=</span> <span class="n">sb</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">print</span><span class="p">(</span><span class="s2">&quot;multipartRequestBody&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">print</span><span class="p">(</span><span class="n">multipartRequestBody</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">js</span><span class="p">.</span><span class="n">scoped</span><span class="p">(()</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="n">request</span> <span class="o">=</span> <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">gapi</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">request</span><span class="p">(</span>
</span><span class='line'>            <span class="n">js</span><span class="p">.</span><span class="n">map</span><span class="p">({</span>
</span><span class='line'>              <span class="s1">&#39;path&#39;</span><span class="o">:</span> <span class="s1">&#39;/upload/drive/v2/files&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;method&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;uploadType&#39;</span><span class="o">:</span> <span class="s1">&#39;multipart&#39;</span><span class="p">},</span>
</span><span class='line'>              <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;multipart/mixed; boundary=&quot;</span><span class="si">$</span><span class="n">boundary</span><span class="s1">&quot;&#39;</span>
</span><span class='line'>              <span class="p">},</span>
</span><span class='line'>              <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="n">multipartRequestBody</span>
</span><span class='line'>            <span class="p">}));</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">callback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">((</span><span class="n">js</span><span class="p">.</span><span class="n">Proxy</span> <span class="n">jsonResp</span><span class="p">,</span> <span class="kd">var</span> <span class="n">rawResp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">print</span><span class="p">(</span><span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">jsonResp</span><span class="p">));</span>
</span><span class='line'>              <span class="n">print</span><span class="p">(</span><span class="n">rawResp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">Map</span> <span class="n">r</span> <span class="o">=</span> <span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">jsonResp</span><span class="p">));</span>
</span><span class='line'>              <span class="kt">String</span><span class="n">Buffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">String</span><span class="n">Buffer</span><span class="p">();</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sb</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">toString</span><span class="p">());</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sb</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">${</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2"> has been uploaded.&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">query</span><span class="p">(</span><span class="s1">&#39;#text&#39;</span><span class="p">).</span><span class="n">text</span> <span class="o">=</span> <span class="n">sb</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">request</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="n">uploadFile</span><span class="p">(</span><span class="n">Event</span> <span class="n">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">js</span><span class="p">.</span><span class="n">scoped</span><span class="p">(</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">gapi</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;drive&#39;</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">(()</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="n">file</span> <span class="o">=</span> <span class="n">evt</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">files</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>          <span class="n">insertFile</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}));</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">handleAuthResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">((</span><span class="n">js</span><span class="p">.</span><span class="n">Proxy</span> <span class="n">authResult</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Map</span> <span class="n">dartAuthResult</span> <span class="o">=</span> <span class="n">JSON</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">authResult</span><span class="p">));</span>
</span><span class='line'>      <span class="n">print</span><span class="p">(</span><span class="s2">&quot;dartAuthResult = </span><span class="si">${</span><span class="n">dartAuthResult</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="n">authButton</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="s1">&#39;#authorizeButton&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="n">filePicker</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="s1">&#39;#filePicker&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">authButton</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">filePicker</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dartAuthResult</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Access token has been successfully retrieved, requests can be sent to the API.</span>
</span><span class='line'>        <span class="n">filePicker</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">filePicker</span><span class="p">.</span><span class="n">on</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="n">uploadFile</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">authButton</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">authButton</span><span class="p">.</span><span class="n">on</span><span class="p">.</span><span class="n">click</span><span class="p">.</span><span class="n">add</span><span class="p">((</span><span class="n">Event</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">js</span><span class="p">.</span><span class="n">scoped</span><span class="p">(()</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">gapi</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">authorize</span><span class="p">(</span>
</span><span class='line'>                <span class="n">js</span><span class="p">.</span><span class="n">map</span><span class="p">({</span>
</span><span class='line'>                    <span class="s1">&#39;client_id&#39;</span><span class="o">:</span> <span class="n">CLIENT_ID</span><span class="p">,</span>
</span><span class='line'>                    <span class="s1">&#39;scope&#39;</span><span class="o">:</span> <span class="n">SCOPE</span><span class="p">,</span>
</span><span class='line'>                    <span class="s1">&#39;immediate&#39;</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>                  <span class="p">}),</span>
</span><span class='line'>                  <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">handleAuthResult</span><span class="p">);</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">handleClientLoad</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">(()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">setTimeout</span><span class="p">(</span><span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">checkAuth</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">checkAuth</span> <span class="o">=</span> <span class="k">new</span> <span class="n">js</span><span class="p">.</span><span class="n">Callback</span><span class="p">.</span><span class="n">many</span><span class="p">(()</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">gapi</span><span class="p">.</span><span class="n">auth</span><span class="p">.</span><span class="n">authorize</span><span class="p">(</span>
</span><span class='line'>          <span class="n">js</span><span class="p">.</span><span class="n">map</span><span class="p">({</span>
</span><span class='line'>              <span class="s1">&#39;client_id&#39;</span><span class="o">:</span> <span class="n">CLIENT_ID</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;scope&#39;</span><span class="o">:</span> <span class="n">SCOPE</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;immediate&#39;</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>            <span class="p">}),</span>
</span><span class='line'>            <span class="n">js</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">handleAuthResult</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ScriptElement</span> <span class="n">script</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScriptElement</span><span class="p">();</span>
</span><span class='line'>  <span class="n">script</span><span class="p">.</span><span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;http://apis.google.com/js/client.js?onload=handleClientLoad&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">script</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="n">document</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">children</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">script</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


