---
title: 'Code Generation and Polymer i18n'
layout: post
tags:
    - chain
    - dart
    - dartlang
    - i18n
    - polymer
category: japhr-by-chris-strom
published: '2013-12-24T23:59:00-05:00'

---

<div class=top-chain-links></div><br />So how do internationalization messages work in <a href="http://dartlang.org">Dart</a>? I was able to make good use of <code>Intl.plural()</code> in a silly <a href="http://www.polymer-project.org/">Polymer</a> example yesterday. I even used <code>Intl.message()</code>, but I am pretty sure it is just dead code at this point.<br /><br />My Polymer displays a locale-dependent greeting, buttons and the number of balloons that a person has:<br /><br /><a href="http://2.bp.blogspot.com/-PUtQuGKinGk/Urm25fJJYaI/AAAAAAAAUm8/EsjWMA_rz2c/s1600/01-ballons_rouges.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-PUtQuGKinGk/Urm25fJJYaI/AAAAAAAAUm8/EsjWMA_rz2c/s640/01-ballons_rouges.png" /></a><br /><br />Thanks to <code>Intl.plural()</code>, my Polymer can display proper grammar versions of the number of balloons that I have be it 99 or 1:<br /><br /><a href="http://1.bp.blogspot.com/-YDIRfvdR-lA/UrnAPHvgjPI/AAAAAAAAUng/50eYZZRhCDA/s1600/02-french_one_balloon.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-YDIRfvdR-lA/UrnAPHvgjPI/AAAAAAAAUng/50eYZZRhCDA/s640/02-french_one_balloon.png" /></a><br /><br />Or even, sadly no red balloons:<br /><br /><a href="http://4.bp.blogspot.com/-eJugrzeAjHI/UrnAPGBgC5I/AAAAAAAAUnc/v37DNQhkb5k/s1600/01-french_no_balloons.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-eJugrzeAjHI/UrnAPGBgC5I/AAAAAAAAUnc/v37DNQhkb5k/s640/01-french_no_balloons.png" /></a><br /><br />I am doing this with locale-specific maps that are chosen at runtime:<pre class="prettyprint"><code>  static Map get fr => {<br />    'hello': 'Bonjour',<br />    'done': 'Fin',<br />    'how_many': 'Combien?',<br />    'instructions': 'Présentez-vous une expérience personnalisée incroyable!',<br /><b>    'count_message': (count) =><br />      Intl.message(<br />        '''<br />        ${Intl.plural(<br />            count,<br />            zero: "Je n'ai pas de ballon rouge",<br />            one: "J'ai un ballon rouge",<br />            other: "J'ai $count ballons rouges"<br />          )}.''')</b><br />  };</code></pre>I am using <code>Intl.message()</code> for the <code>count_message</code> propery-function. But as I mentioned, it serves no purpose. In fact it rather gets in the way. If I remove it, the code still works and is far more readable:<pre class="prettyprint"><code>  static Map get fr => {<br />    // ...<br />    'count_message': (count) =><br />      Intl.plural(<br />        count,<br />        zero: "Je n'ai pas de ballon rouge",<br />        one: "J'ai un ballon rouge",<br />        other: "J'ai $count ballons rouges"<br />      )<br />  };</code></pre>But darn it, <code>Intl.message()</code> does <i>something</i>. <br /><br />I extract the <code>Intl.message()</code> call out in to a function:<pre class='prettyprint'>count_message(count) =><br />  Intl.message(<br />    '''<br />    ${Intl.plural(<br />        count,<br />        zero: "Je n'ai pas de ballon rouge",<br />        one: "J'ai un ballon rouge",<br />        other: "J'ai $count ballons rouges"<br />    )}.''',<br />    name: 'count_message',<br />    desc: 'Reports the number of red balloons a person has.',<br />    args: [count],<br />    examples: {'count': 99}<br />  );</pre>And I dig through the <code>intl</code> code to find that I should:<pre class='prettyprint'>$ dart \<br />  --package-root=packages \<br />  /home/chris/.pub-cache/hosted/pub.dartlang.org/intl-0.9.1/test/message_extraction/extract_to_json.dart \<br />  lib/hello_you.dart</pre>Which produces a <code>intl_messages.json</code> file with:<pre class="prettyprint">[{<br />  "name":"count_message",<br />  "desc":"Reports the number of red balloons a person has.",<br />  "examples":"{'count' : 99}",<br />  "args":[],<br />  "message":"\n    ${Intl.plural(count, zero: 'Je n\\'ai pas de ballon rouge', one: 'J\\'ai un ballon rouge', other: 'J\\'ai ${count} ballons rouges')}."<br />}]</pre>(the actual file output is one a single line -- I split the lines here for readability)<br /><br />Great. So what does this file actually do?<br /><br />Well, based on the documentation, I think it mostly serves as a template for translation_* files. I think that I have likely made a mistake here starting with the French, so I am going to create a separate French translation as well as an English translation in <code>translation_en.json</code>:<pre class="prettyprint">{<br />  "locale": "en",<br />  "count_message": "${Intl.plural(count, zero: 'I have no red balloons', one: 'I have one red balloon', other: 'I have ${count} red balloons')}."<br />}</pre>Then I run the opposite of the original <code>extract_to_json.dart</code> script. Now I need to <code>generate_from_json.dart</code>. This uses the same command line arguments as the previous script, but now includes the <code>translation_*</code> files as well:<pre class="prettyprint">$ dart \<br />  --package-root=packages \<br />  /home/chris/.pub-cache/hosted/pub.dartlang.org/intl-0.9.1/test/message_extraction/<b>generate_from_json.dart</b> \<br />  lib/hello_you.dart \<br />  <b>translation_en.json translation_fr.json</b></pre>That fails for me with the following error:<pre class="prettyprint">Unable to open file: /home/chris/repos/polymer-book/play/i18n/dart/packages/serialization/serialization.dart'file:///home/chris/.pub-cache/hosted/pub.dartlang.org/intl-0.9.1/test/message_extraction/generate_from_json.dart': error: line 25 pos 1: library handler failed<br />import 'package:serialization/serialization.dart';<br />^</pre>Bleh. So I add <code>serialization</code> to my <code>pubspec.yaml</code>, <code>pub get</code> and try again. And <i>still</i> get an error:<pre class="prettyprint">Unhandled exception:<br />The null object does not have a getter 'string'.<br /><br />NoSuchMethodError : method not found: 'string'<br />Receiver: null<br />Arguments: []<br />#0      Object.noSuchMethod (dart:core-patch/object_patch.dart:42)<br />#1      generateLocaleFile (file:///home/chris/.pub-cache/hosted/pub.dartlang.org/intl-0.9.1/test/message_extraction/generate_from_json.dart:95:32)<br />#2      main (file:///home/chris/.pub-cache/hosted/pub.dartlang.org/intl-0.9.1/test/message_extraction/generate_from_json.dart:63:23)<br />#3      _startIsolate.isolateStartHandler (dart:isolate-patch/isolate_patch.dart:188)<br />#4      _RawReceivePortImpl._handleMessage (dart:isolate-patch/isolate_patch.dart:93)</pre>Looking through the code in the stacktrace, it seems that my JSON translation files need a <code>_locale</code> attribute, not a <code>locale</code> attribute:<pre class="prettyprint">{<br /><b>  "_locale": "fr",</b><br />  "count_message": "${Intl.plural(count, zero: 'Je n\\'ai pas de ballon rouge', one: 'J\\'ai un ballon rouge', other: 'J\\'ai ${count} ballons rouges')}."<br />}</pre>With that now working, I have three new files:<code>messages_all.dart</code>, <code>messages_en.dart</code>, and <code>messages_fr.dart</code>.<br /><br />So what do I do with these? <br /><br />I start with a simple import:<pre class="prettyprint">import 'messages_all.dart';</pre>That, combined with setting the <code>Intl.defaultLocale</code> has no effect in the code -- the default French message is always shown. I find that I need to call the <code>initializeMessages()</code> function from the generated <code>messages_all.dart</code> file:<pre class="prettyprint">@CustomTag('hello-you')<br />class HelloYou extends PolymerElement {<br />  @observable String balloon_message;<br />  // ...<br />  HelloYou.created(): super.created() {<br /><b>    initializeMessages('en_US');</b><br />  }<br />  // ...<br />  updateCount() {<br />    // count_message is the i18n function:<br />    balloon_message = count_message(int.parse(count));<br />  }<br />}</pre>With that, I am setting my locale such that the <code>count_message()</code> function will honor it. Almost:<br /><br /><a href="http://2.bp.blogspot.com/-KWsOnZJjbbI/UrpjLJyHH4I/AAAAAAAAUn8/eA6kAXVl4gI/s1600/03-almost_i18n_en.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-KWsOnZJjbbI/UrpjLJyHH4I/AAAAAAAAUn8/eA6kAXVl4gI/s640/03-almost_i18n_en.png" /></a><br /><br />It seems that my <code>translation_en.json</code> is not generating a proper <code>messages_en.dart</code>. At this point, I just want to get this working, so I remove backslashes from <code>messages_en.dart</code>:<pre class="prettyprint">class MessageLookup extends MessageLookupByLibrary {<br />  get localeName => 'en';<br />  static count_message(count) => "\${Intl.plural(count, zero: \'I have no red balloons\', one: \'I have one red balloon\', other: \'I have ${count} red balloons\')}.";<br />  // ...<br />}</pre>After removing the backslashes, I am left with:<pre class="prettyprint"><code>  static count_message(count) => "${Intl.plural(count, zero: 'I have no red balloons', one: 'I have one red balloon', other: 'I have ${count} red balloons')}.";</code></pre>Then I have my Dart <code>intl</code>-based solution working.<br /><br />Having gone through all that, I can safely say that this is a huge pain. Even if the code was not mis-generated in the last step, this feels awkward to use. Much of that is probably my own biases, so I am not dismissing this approach outright. I personally prefer metaprogramming to code generation. But I recognize that code generation may very well be the right approach in this case. I also recognize that this approach may scale a little better than my poor man's map-based approach.<br /><br />But in the end, I do not understand what the <code>intializeMessages()</code> does—even after digging through it. That alone may be enough to push me away. But I will sleep on it first.<br /><br /><br /><span style="color: #ccc">Day #975</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2013/12/dart-intlmessage.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2013/12/rel-import-of-non-polymers.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script>
