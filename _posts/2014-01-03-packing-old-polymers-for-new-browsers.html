---
title: 'Packing Old Polymers for New Browsers'
layout: post
tags:
    - chain
    - code-editor
    - dart
    - dartlang
    - polymer
category: japhr-by-chris-strom
published: '2014-01-03T23:58:00-05:00'

---

<div class=top-chain-links></div><br />This is crazy. Somehow I do not have a running sample of an <code>&lt;ice-code-editor></code> <a href="http://www.polymer-project.org/">Polymer</a> available anywhere. At various times I had gotten this working. I even have a <a href="http://japhr.blogspot.com/2013/03/exporting-ice.html">post from last year</a> that worked at one point. But now nothing. Since I wanted to explore wrapping Polymer around existing, large codebases anyway, this seems a good opportunity.<br /><br />First, it has been a while since I last tried to Polymerize the <a href="https://github.com/eee-c/ice-code-editor">ICE Code Editor</a>. None of the samples that I include in the <code>web</code> directory are working anymore. A quick scan of <code>git log</code> reveals that my last Polymer work was pre-Dart 1.0:<br /><br /><a href="http://1.bp.blogspot.com/-5qqRoyJLwvE/Usd5t1bx5dI/AAAAAAAAUvw/gsDGdINfglE/s1600/01-pre_dart_1_0.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-5qqRoyJLwvE/Usd5t1bx5dI/AAAAAAAAUvw/gsDGdINfglE/s640/01-pre_dart_1_0.png" /></a><br /><br />I cherry-pick that 1.0 commit (<code>git cherry-pick f698145</code>) rather than rebasing the <code>polymer</code> branch onto the latest master branch. Hopefully that is all I need to get things working again and it seems less likely to (a) devolve into resolving multiple merge conflicts and (b) introduce other, unrelated problems.<br /><br />And that does get most of the examples working. It even gets an embedded example working:<br /><br /><a href="http://4.bp.blogspot.com/-ugSH4JV7Iw8/Usd7LuaWZTI/AAAAAAAAUv8/A2F11Fknmys/s1600/02-working_embedded.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-ugSH4JV7Iw8/Usd7LuaWZTI/AAAAAAAAUv8/A2F11Fknmys/s640/02-working_embedded.png" /></a><br /><br />But that was a pre-Polymer attempt at a similar solution. Unfortunately, I seem to have a Polymer bug. Hopefully it is just an old-version-of-polymer bug:<pre class="prettyprint">Internal error: 'package:polymer_expressions/polymer_expressions.dart': Error: line 53 pos 34: cannot resolve class 'BindingDelegate' from 'PolymerExpressions'<br />class PolymerExpressions extends BindingDelegate {<br />                                 ^ </pre>And, holy cow, I am using an old, modified, locally installed version of Polymer per my <code>pubspec.yaml</code>:<pre class="prettyprint">name: ice_code_editor<br /># ...<br />dependencies:<br />  crypto: any<br />  js: any<br />  ctrl_alt_foo: any<br />  json: any<br /><b>  polymer: {path: /home/chris/repos/dart/dart/pkg/polymer}</b></pre>Heh. Any time I think I am living too close to the bleeding edge for <a href="http://patternsinpolymer.com">Patterns in Polymer</a> I can now remind myself that at least this kind of hacking is no longer necessary.<br /><br />I switch to the latest, <i>packaged</i> Polymer:<pre class="prettyprint">name: ice_code_editor<br /># ...<br />dependencies:<br />  crypto: any<br />  js: any<br />  ctrl_alt_foo: any<br />  json: any<br /><b>  polymer: any</b></pre>After that change, I <code>pub get</code>, which gets me to one of my favorite games: “my, how things have changed!”<br /><br />Instead of the old combination of JavaScript boot script and Polymer import, I switch to the new export-init-script:<pre class="prettyprint">&lt;head><br />  &lt;!-- Load component(s) --><br />  &lt;link rel="import" href="packages/ice_code_editor/polymer/ice_code_editor.html"><br /><b>  &lt;!-- Load Polymer --><br />  &lt;script type="application/dart"><br />    export 'package:polymer/init.dart';<br />  &lt;/script></b><br />&lt;/head></pre>In the olden days of 2013, I had to mixin an observable class into my Polymer definition—no more. There used to be a <code>create()</code> lifecycle method as in the JavaScript version of Polymer—now it is a named constructor. Lastly, to manipulate the DOM of the current element, I previously had to go through the <code>host</code> property—now I can call <code>append()</code> directly.<br /><br />The end result looks much more familiar to me after my recent 1.5 month deep-dive into all things Polymer:<pre class="prettyprint">import 'package:polymer/polymer.dart';<br /><br />import 'dart:html';<br />import 'package:ice_code_editor/ice.dart' as ICE;<br /><br />@CustomTag('ice-code-editor')<br />class IceCodeEditorElement extends PolymerElement {<br />  @published String src;<br />  @published int line_number = 0;<br />  ICE.Editor editor;<br /><br />  IceCodeEditorElement.created(): super.created() {<br />    var container = new DivElement()<br />      ..id = 'ice-${this.hashCode}'<br />      ..style.width = '600px'<br />      ..style.height = '400px';<br /><br />    append(container);<br />    // ...<br />  }<br />  // ...<br />}</pre>And that does the trick. I have my custom <code>&lt;ice-code-editor></code> element back and am able to embed multiple instances of it:<br /><br /><a href="http://3.bp.blogspot.com/-IOE_D1qNZmk/UseCWQZfZlI/AAAAAAAAUwM/EBLkcCbjYJI/s1600/03-polymerized_again.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-IOE_D1qNZmk/UseCWQZfZlI/AAAAAAAAUwM/EBLkcCbjYJI/s640/03-polymerized_again.png" /></a><br /><br />But that is only half of tonight's battle. I also wanted to deploy this. That raises a very important question: how the heck do you deploy Polymer.dart code?<br /><br />I know that I need at least one thing added to make that happen—a Pub transformer. To make ready its custom elements, Polymer.dart includes a build “transformer” that does all of the necessary work. Specifying a transformer is done in the <code>pubspec.yaml</code> file:<pre class="prettyprint">name: ice_code_editor<br /># ...<br />dependencies:<br />  crypto: any<br />  js: any<br />  ctrl_alt_foo: any<br />  json: any<br />  polymer: any<br /><b>transformers:<br />- polymer:<br />    entry_points: web/polymer.html</b></pre>But, even though this worked fine from Dartium, the resultant <code>pub serve</code> fails. When I load the <code>polymer.html</code> test page, I get a 404 for <code>http://localhost:8080/polymer.html_bootstrap.dart.js</code>. Checking the output from the <code>pub serve</code> web server log, I see a bunch of warnings and errors—errors like:<pre class="prettyprint">Build error:<br />Transform Dart2JS on ice_code_editor|web/polymer.html_bootstrap.dart threw error: 'file:///mnt/data/b/build/slave/dart-editor-linux-stable/build/dart/<br />sdk/lib/_internal/pub/lib/src/barback/dart2js_transformer.dart': malformed type: line 118: type 'CompilerException' is not loaded<br />                if (error is CompilerException) return; <br />                             ^<br />malformed type used.<br />../../../../mnt/data/b/build/slave/dart-editor-linux-stable/build/dart/sdk/lib/_internal/pub/lib/src/barback/dart2js_transformer.dart 118  Dart2JSTransformer.apply.&lt;fn>.&lt;fn></pre>Eventually, I read enough of the errors to realize that one of them contains useful information. It seems that I have one last holdover from the ancient 2013 version of Polymer.dart. The method signature for <code>attributeChanged()</code>, which I am overriding in my Polymer, has changed:<pre class="prettyprint">packages/ice_code_editor/polymer/ice_code_editor_element.dart:33:8: Error: Cannot override method 'attributeChanged' in 'Polymer'; the parameters do not match.<br />  void attributeChanged(String name, String oldValue) {<br />       ^^^^^^^^^^^^^^^^</pre>After fixing that (it now requires a third, <code>newValue</code> parameter), I am in business. My <code>&lt;ice-code-editor></code> Polymer works in Chrome just like it did in Dartium:<br /><br /><a href="http://4.bp.blogspot.com/-DNYsx4-w9t8/UseQwmuVLoI/AAAAAAAAUwc/vY7n1RK_icM/s1600/04-build_js_polymerized.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-DNYsx4-w9t8/UseQwmuVLoI/AAAAAAAAUwc/vY7n1RK_icM/s640/04-build_js_polymerized.png" /></a><br /><br />Once that is working, I can <code>pub build</code> my page, which dumps output into the <code>build</code> subdirectory. Once it is done, I start a simple HTTP server in there:<pre class="prettyprint">➜  build git:(polymer) ✗ python -m SimpleHTTPServer 8000<br />Serving HTTP on 0.0.0.0 port 8000 ...</pre>With that, I can access my Polymer from any static site with any modern web browser:<br /><br /><a href="http://2.bp.blogspot.com/-SQzLNgW1zls/UseUYh0s1NI/AAAAAAAAUwo/-irjtAkk8po/s1600/05-polymer_in_ff.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-SQzLNgW1zls/UseUYh0s1NI/AAAAAAAAUwo/-irjtAkk8po/s640/05-polymer_in_ff.png" /></a><br /><br />Nice! I still need to build for production (this includes some debug code). I would also like to see if I can shrink the codesize down some. Between the editor and the visualization layer, there is a lot of code. Still the current 2.5 MB seems excessive. But hopefully the hard part is out of the way.<br /><br /><span style="color: #ccc">Day #985</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/01/creating-polymer-package-for-bower.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/01/building-minified-polymer-libraries.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script>
