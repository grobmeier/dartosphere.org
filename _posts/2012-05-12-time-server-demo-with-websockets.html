---
title: 'Time Server Demo with WebSockets'
layout: post
tags: {  }
category: dartery
published: '2012-05-12T19:11:00-07:00'

---

Continuing from the last post on <a href="http://dartery.blogspot.com/2012/05/simple-async-http-static-file-server-in.html">static file serving</a>, here's a version of the Time Server demo that uses WebSockets to push time updates from the server to the browser.<br /><br />Compared to my <a href="http://dartery.blogspot.com/2012/02/experimenting-with-websockets.html">last experiment with WebSockets</a>&nbsp;just two months ago, Dart has come a <b>long</b>&nbsp;way. I'm not sure it can get much easier that this!<br /><br />First, here's server.dart:<br /><div class="syntax"><pre>#<span class="k">import</span><span class="p">(</span><span class="s1">'dart:io'</span><span class="p">);</span><br /><br /><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="o">&gt;</span> <span class="n">contentTypes</span> <span class="o">=</span> <span class="kd">const</span> <span class="p">{</span><br />  <span class="s2">"html"</span><span class="o">:</span> <span class="s2">"text/html; charset=UTF-8"</span><span class="p">,</span><br />  <span class="s2">"dart"</span><span class="o">:</span> <span class="s2">"application/dart"</span><span class="p">,</span><br />  <span class="s2">"js"</span><span class="o">:</span> <span class="s2">"application/javascript"</span><span class="p">,</span> <br /><span class="p">};</span><br /><br /><span class="n">List</span><span class="o">&lt;</span><span class="n">WebSocketConnection</span><span class="o">&gt;</span> <span class="n">connections</span><span class="p">;</span><br /><br /><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span><br />  <span class="n">connections</span> <span class="o">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">();</span><br />  <br />  <span class="n">WebSocketHandler</span> <span class="n">wsHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocketHandler</span><span class="p">();</span><br />  <span class="n">wsHandler</span><span class="p">.</span><span class="n">onOpen</span> <span class="o">=</span> <span class="p">(</span><span class="n">WebSocketConnection</span> <span class="n">conn</span><span class="p">)</span> <span class="p">{</span><br />    <span class="n">connections</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>    <br />    <span class="n">conn</span><span class="p">.</span><span class="n">onClosed</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">removeConnection</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><br />    <span class="n">conn</span><span class="p">.</span><span class="n">onError</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">removeConnection</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><br />  <span class="p">};</span><br /><br />  <span class="n">HttpServer</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpServer</span><span class="p">();</span><br />  <span class="n">server</span><span class="p">.</span><span class="n">addRequestHandler</span><span class="p">((</span><span class="n">HttpRequest</span> <span class="n">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/time"</span><span class="p">),</span> <span class="n">wsHandler</span><span class="p">.</span><span class="n">onRequest</span><span class="p">);</span><br />  <span class="n">server</span><span class="p">.</span><span class="n">addRequestHandler</span><span class="p">((_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span> <span class="n">serveFile</span><span class="p">);</span>  <br />  <br />  <span class="k">new</span> <span class="n">Timer</span><span class="p">.</span><span class="n">repeating</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">Timer</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span><br />    <span class="n">Date</span> <span class="n">time</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="p">.</span><span class="n">now</span><span class="p">();</span><br />    <span class="n">connections</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">WebSocketConnection</span> <span class="n">conn</span><span class="p">)</span> <span class="p">{</span><br />      <span class="n">conn</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">toString</span><span class="p">());</span><br />    <span class="p">});</span><br />  <span class="p">});</span><br />  <br />  <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="s2">"127.0.0.1"</span><span class="p">,</span> <span class="m">8080</span><span class="p">);</span>  <br /><span class="p">}</span><br /><br /><span class="c1">/// Very simple async static file server. Possibly insecure!</span><br /><span class="kt">void</span> <span class="n">serveFile</span><span class="p">(</span><span class="n">HttpRequest</span> <span class="n">req</span><span class="p">,</span> <span class="n">HttpResponse</span> <span class="n">resp</span><span class="p">)</span> <span class="p">{</span><br />  <span class="kt">String</span> <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">endsWith</span><span class="p">(</span><span class="s1">'/'</span><span class="p">))</span> <span class="o">?</span> <span class="s2">".</span><span class="si">${</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="s2">index.html"</span> <span class="o">:</span> <span class="s2">".</span><span class="si">${</span><span class="n">req</span><span class="p">.</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span><br />  <span class="n">print</span><span class="p">(</span><span class="s2">"serving </span><span class="si">$</span><span class="n">path</span><span class="s2">"</span><span class="p">);</span><br />  <br />  <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><br />  <span class="n">file</span><span class="p">.</span><span class="n">exists</span><span class="p">().</span><span class="n">then</span><span class="p">((</span><span class="kt">bool</span> <span class="n">exists</span><span class="p">)</span> <span class="p">{</span><br />    <span class="k">if</span> <span class="p">(</span><span class="n">exists</span><span class="p">)</span> <span class="p">{</span><br />      <span class="n">file</span><span class="p">.</span><span class="n">readAsText</span><span class="p">().</span><span class="n">then</span><span class="p">((</span><span class="kt">String</span> <span class="n">text</span><span class="p">)</span> <span class="p">{</span><br />        <span class="n">resp</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="n">HttpHeaders</span><span class="p">.</span><span class="n">CONTENT_TYPE</span><span class="p">,</span> <span class="n">getContentType</span><span class="p">(</span><span class="n">file</span><span class="p">));</span><br />        <span class="n">resp</span><span class="p">.</span><span class="n">outputStream</span><span class="p">.</span><span class="n">writeString</span><span class="p">(</span><span class="n">text</span><span class="p">);</span><br />        <span class="n">resp</span><span class="p">.</span><span class="n">outputStream</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><br />      <span class="p">});</span>      <br />    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><br />      <span class="n">resp</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">=</span> <span class="n">HttpStatus</span><span class="p">.</span><span class="n">NOT_FOUND</span><span class="p">;</span><br />      <span class="n">resp</span><span class="p">.</span><span class="n">outputStream</span><span class="p">.</span><span class="n">close</span><span class="p">();</span><br />    <span class="p">}</span><br />  <span class="p">});</span><br /><span class="p">}</span><br /><br /><span class="kt">String</span> <span class="n">getContentType</span><span class="p">(</span><span class="n">File</span> <span class="n">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">contentTypes</span><span class="p">[</span><span class="n">file</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">).</span><span class="n">last</span><span class="p">()];</span><br /><br /><span class="kt">void</span> <span class="n">removeConnection</span><span class="p">(</span><span class="n">WebSocketConnection</span> <span class="n">conn</span><span class="p">)</span> <span class="p">{</span><br />  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">connections</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span><br />  <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span><br />    <span class="n">connections</span><span class="p">.</span><span class="n">removeRange</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span><br />  <span class="p">}</span><br /><span class="p">}</span><br /></pre></div><br />I think it's incredibly straight forward. Here's the important bits:<br /><br /><ol><li>First we set up a very basic WebSocket handler that adds each incoming WebSocketConnection to a list, and removes the connection when it's closed or if there's an error.</li><li>Then we create the HTTP server use the WebSocket handler for /time and the static file handler for everything else.</li><li>Finally we create a Timer that updates all the connections once a second.</li></ol><div><br /></div><div>Now for the client side. If you put these files in the same folders as server.dart, and compile client.dart to JavaScript, everything should just work when you run the server.<br /><br />index.html:</div><div class="syntax"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span><br /><br /><span class="nt">&lt;html&gt;</span><br />  <span class="nt">&lt;head&gt;</span><br />    <span class="nt">&lt;title&gt;</span>Server Timer<span class="nt">&lt;/title&gt;</span><br />    <span class="nt">&lt;style&gt;</span><br />      <span class="nt">body</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="nb">teal</span><span class="p">;</span> <span class="p">}</span><br />      <span class="nt">h2</span> <span class="p">{</span> <span class="k">background-color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span> <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">8px</span><span class="p">;</span><br />           <span class="k">border</span><span class="o">:</span><span class="k">solid</span> <span class="m">1px</span> <span class="m">#555</span><span class="p">;</span> <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span> <span class="k">padding</span><span class="o">:</span> <span class="m">0.5em</span><span class="p">;</span> <span class="p">}</span><br />    <span class="nt">&lt;/style&gt;</span><br />  <span class="nt">&lt;/head&gt;</span><br />  <span class="nt">&lt;body&gt;</span><br />    <span class="nt">&lt;h2&gt;</span>Server Time:<span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"time"</span><span class="nt">/&gt;&lt;/h2&gt;</span><br />    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"application/dart"</span> <span class="na">src=</span><span class="s">"client.dart"</span><span class="nt">&gt;&lt;/script&gt;</span><br />    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://dart.googlecode.com/svn/branches/bleeding_edge/dart/client/dart.js"</span><span class="nt">&gt;&lt;/script&gt;</span><br />  <span class="nt">&lt;/body&gt;</span><br /><span class="nt">&lt;/html&gt;</span><br /></pre></div><br />client.dart:<br /><div class="syntax"><pre>#<span class="k">import</span><span class="p">(</span><span class="s1">'dart:html'</span><span class="p">);</span><br /><br /><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span><br />  <span class="k">new</span> <span class="n">WebSocket</span><span class="p">(</span><span class="s2">"ws://localhost:8080/time"</span><span class="p">).</span><span class="n">on</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">add</span><span class="p">((</span><span class="n">MessageEvent</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span><br />    <span class="n">document</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"#time"</span><span class="p">).</span><span class="n">innerHTML</span> <span class="o">=</span> <span class="s2">"</span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="n">data</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span><br />  <span class="p">});</span><br /><span class="p">}</span><br /></pre></div><div><br /></div><div>Here we simply have a WebSocket object that connects to the server at the /time URL and replaces the text of our #time span with whatever message it receives.<br /><br />I don't know about you, but this is so much simpler than the numerous hacks of Flash, Comet, hanging GETs, etc. that have been used over the years that I'm ready to start making collaborative apps with WebSockets and forget about supporting older browsers. Well... in my day job I <i>have</i>&nbsp;to support at least middle aged browsers, so I'm half kidding. But still...<br /><br />Next time I get to experiment again I think I'll be working on a bi-directional RPC mechanism. Either that or a painting app for something completely different.<br /><br />Awesome work Dart team, and have fun Dartisans!</div>
