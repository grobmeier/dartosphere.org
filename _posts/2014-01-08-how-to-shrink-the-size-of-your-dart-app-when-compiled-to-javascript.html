---
title: 'How to shrink the size of your Dart app when compiled to JavaScript'
layout: post
tags:
    - dart
    - dartlang
category: seth-ladds-blog
published: '2014-01-08T23:07:00-08:00'

---

So you caught the Dart bug and you're enjoying using the structured language, comprehensive libraries, and productive tools. Great! Except, when you compiled your Dart app to JavaScript, the output was bigger than expected. Read this post to learn how to reduce the size of your JavaScript output. Small apps are fast apps!<br /><br /><h2>Make sure you are minifying</h2><br />The dart2js compiler can minify your JavaScript. However, minification is not the default. Make sure you opt-into minification before you deploy to production.<br /><br />How can you tell if you minified? Take a look at the generated JavaScript and you'll know. Minified JavaScript replaces variables names, function names, and more with shorter names. It also moves code around to use less lines.<br /><br />If you compile your app from the command line, use --minify:<br /><br /><span style="font-family: Courier New, Courier, monospace;">dart2js --minify -o=app.dart.js app.dart</span><br /><br />If you use <a href="http://pub.dartlang.org/doc/pub-build.html">pub build</a> (a streamlined build process for pub package and apps), it defaults to minifying. Yay!<br /><br />If you use Dart Editor, it's a bit more tricky. Follow the <a href="http://stackoverflow.com/questions/19017116/how-do-i-minify-javascript-code-compiled-from-dart-editor">instructions</a> I posted on StackOverflow for screenshots and a walk through. You need to add --minify to the Run config in Manage Launches.<br /><br />You will see a significant reduction in size after you minify.<br /><br /><h2>Make sure all dart:mirrors imports use&nbsp;@MirrorsUsed</h2><br />Dart's reflection capabilities come from the <a href="https://api.dartlang.org/docs/channels/stable/latest/dart_mirrors.html">mirrors library</a>. Mirrors are really powerful, but they introduce challenges to dart2js's tree shaking abilities. Normally, dart2js can look at the entire app and deduce what code is required to run the app. However, as of the time of this writing, mirrors (due to their API design and highly dynamic nature) more-or-less disable dart2js's tree shaking.<br /><br />Enter&nbsp;<a href="https://api.dartlang.org/docs/channels/stable/latest/dart_mirrors/MirrorsUsed.html">@MirrorsUsed</a>, a <a href="https://www.dartlang.org/docs/dart-up-and-running/contents/ch02.html#ch02-metadata">metadata annotation</a>, which explicitly states what parts of the program are reflected. Tools like dart2js can use&nbsp;@MirrorsUsed to re-enable tree shaking.<br /><br /><i>Note: by the time you read this article,&nbsp;@MirrorsUsed might be deprecated or removed. The engineers are working on better ways to deduce how mirrors are used in the code. As of the time of this writing,&nbsp;@MirrorsUsed is the tool we have to gain control over the output size when mirrors are used.</i><br /><br />If your app imports dart:mirrors and you compile it with dart2js, you might see a warning like this:<br /><br /><div class="p1"><span style="font-family: Courier New, Courier, monospace;"><span class="s1">sethladd</span>:~/dart/test/web$ dart2js test.dart&nbsp;</span></div><div class="p2"><span style="font-family: Courier New, Courier, monospace;"><span class="s2">test.dart:1:1: </span>Hint: 6379 methods retained for use by dart:mirrors out of 7873 total methods (81%).</span></div><div class="p1"><span style="font-family: Courier New, Courier, monospace;">import 'dart:html';</span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p4"><span style="font-family: Courier New, Courier, monospace;"><span class="s2">mylibrary.dart:3:1: </span>Info: This import is not annotated with @MirrorsUsed, which may lead to unnecessarily large generated code.</span></div><div class="p4"><span style="font-family: Courier New, Courier, monospace;">Try adding '@MirrorsUsed(...)' as described at https://goo.gl/Akrrog.</span></div><div class="p4"><span style="font-family: Courier New, Courier, monospace;">import 'dart:mirrors';</span></div><br /><div class="p4"><span style="font-family: Courier New, Courier, monospace;">^^^^^^^^^^^^^^^^^^^^^^</span></div><div class="p4"><br /></div><div class="p4">If you see "This import is not annotated with&nbsp;@MirrorsUsed", then the generated JavaScript is probably too big. My sample app, which uses UUID, HTML, and mirrors, compiles out to &gt; 4MB. Yikes. But we can fix it!</div><div class="p4"><br /></div><div class="p4">At the import of dart:mirrors, add a&nbsp;@MirrorsUsed and specify what the app reflects on. You can specify:</div><div class="p4"></div><ul><li>targets: one or more names of libraries or classes</li><li>metaTargets: one or more classes used as metadata to indicate reflectability</li></ul><div>For example:</div><div><br /></div><br /><div class="p1"><span style="font-family: Courier New, Courier, monospace;"><span class="s1">library</span> mylib;</span></div><div>        <div class="p2"><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p3"><span style="font-family: Courier New, Courier, monospace;">@MirrorsUsed(targets: 'mylib')</span></div><div class="p4"><span style="font-family: Courier New, Courier, monospace;"><span class="s1">import</span><span class="s2"> </span>'dart:mirrors'<span class="s2">;</span></span></div><div class="p4"><span class="s2"><br /></span></div><div class="p4">All names and things (classes, functions, etc) inside of mylib will be retained for reflection.</div><div class="p4"><br /></div><div class="p4">From what I can tell, once dart2js sees a&nbsp;@MirrorsUsed, it then tree shakes and drops all targets that are not specified. So be sure to include a complete list of targets (libraries, classes, etc) that will be reflected.</div><div class="p4"><br /></div><div class="p4">In my test app (uuid, html, mirrors), the generated JavaScript size dropped to 400k unminified (from 4MB unminified) once I added&nbsp;@MirrorsUsed.</div><div class="p4"><br /></div><div class="p4">If the import of dart:mirrors is not under your control (e.g. you use a package that imports a package that uses dart:mirrors), you can introduce your own&nbsp;@MirrorsUsed annotation to override. Just introduce your own import of dart:mirrors in code that you control (e.g. in your entry point file), add&nbsp;@MirrorsUsed, specify targets and metaTargets, and set override: '*'.</div><div class="p4"><br /></div><div class="p4">As mentioned above, Dart engineers are working on making mirrors&nbsp;+ reflection&nbsp;+ dart2js much friendlier. We know&nbsp;@MirrorsUsed is hard to get right, but it's the only tool we have right now at the time of this writing.</div><div class="p4"><br /></div><h2>Make sure you are gzipping</h2><div class="p4"><br /></div><div class="p4">Of course, your web server should perform real-time compression. Be sure to account for gzip when calculating how many bits are traveling across the wire.</div><div class="p4"><br /></div><h2>Summary</h2><div class="p4"><br /></div><div class="p4">To calculate the real size over the wire, minify your app, add&nbsp;@MirrorsUsed if you use mirrors, and enable HTTP compression like Gzip. If you have any questions, please ask on <a href="http://stackoverflow.com/tags/dart">StackOverflow</a> or file a bug at <a href="http://dartbug.com/new">dartbug.com/new</a>.&nbsp;</div></div><img src="http://feeds.feedburner.com/~r/SethLaddsBlog/~4/6MXZ79AyjKU" height="1" width="1"/>
